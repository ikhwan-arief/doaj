<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DOAJ Journals Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700&family=Source+Sans+Pro:wght@400;600;700&family=Source+Code+Pro:wght@500&display=swap" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
  <style>
    :root {
      --bg: #F6F4F4;           /* light-grey */
      --card: #FFFFFF;         /* white */
      --muted: #5C5956;        /* dark-grey */
      --text: #282624;         /* warm-black */
      --accent: #FD5A3B;       /* grapefruit */
      --accent-2: #FA9A87;     /* salmon */
      --accent-3: #47A178;     /* mid-green */
      --border: #D7D2CE;       /* light border */
      --shadow: 0 10px 24px rgba(40, 38, 36, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Source Sans Pro', system-ui, -apple-system, sans-serif;
      background:
        radial-gradient(circle at 20% 20%, rgba(253,90,59,0.08), transparent 35%),
        radial-gradient(circle at 80% 0%, rgba(163,195,134,0.12), transparent 35%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      padding: 24px 28px 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: baseline;
    }
    h1 { margin: 0; font-size: 26px; letter-spacing: -0.4px; font-family: 'Spectral', 'Source Sans Pro', serif; }
    .muted { color: var(--muted); font-size: 14px; }
    .layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
      padding: 0 28px 40px;
    }
    @media (max-width: 960px) {
      .layout { grid-template-columns: 1fr; }
    }
    .panel, .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
    }
    .panel { padding: 18px; }
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin: 0 28px 18px;
    }
    .card {
      padding: 14px 16px;
    }
    .card .label { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; }
    .card .value { font-size: 24px; font-weight: 700; margin-top: 6px; }
    .filters h3 { margin: 0 0 12px; }
    .filter-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }
    label { font-weight: 600; font-size: 14px; }
    select, input, button {
      width: 100%;
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #FFFFFF;
      color: var(--text);
      font-size: 14px;
    }
    input::placeholder { color: #8C8681; }
    button {
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border: none;
      font-weight: 700;
      letter-spacing: 0.02em;
    }
    .charts { display: grid; gap: 14px; padding: 0 28px; }
    .chart-row { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 14px; }
    .chart-row.single { grid-template-columns: 1fr; }
    @media (max-width: 1200px) {
      .chart-row { grid-template-columns: 1fr; }
    }
    .chart-box {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
      box-shadow: var(--shadow);
      min-height: 320px;
    }
    .chart-box.map-box { min-height: 500px; }
    .table-box {
      margin: 18px 28px 40px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 14px;
      overflow-x: auto;
    }
    table { width: 100%; border-collapse: collapse; font-family: 'Source Sans Pro', system-ui, -apple-system, sans-serif; }
    th, td { text-align: left; padding: 8px 6px; border-bottom: 1px solid var(--border); vertical-align: top; }
    th { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.06em; }
    .pill { display: inline-block; padding: 3px 8px; border-radius: 999px; font-size: 12px; background: rgba(71,161,120,0.18); color: #2F6E52; }
    .pill.negative { background: rgba(253,90,59,0.18); color: #8F311C; }
    .pill.warn { background: rgba(152,46,10,0.18); color: #982E0A; margin-left: 6px; }
    .table-link { color: #982E0A; text-decoration: none; font-weight: 600; }
    .table-link:hover { text-decoration: underline; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; background: #22c55e; }
    .status-banner {
      margin: 0 28px 14px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(253, 90, 59, 0.12);
      color: #7A2A18;
      font-size: 14px;
    }
    .status-banner.hidden { display: none; }
    .year-range-wrap { display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; }
    .year-end { font-size: 13px; color: var(--muted); min-width: 42px; text-align: center; font-weight: 700; }
    .year-range-dual { position: relative; width: 100%; height: 24px; }
    .year-range-dual input[type="range"] {
      position: absolute;
      inset: 0;
      width: 100%;
      margin: 0;
      pointer-events: none;
      background: transparent;
    }
    .year-range-dual input[type="range"]::-webkit-slider-thumb { pointer-events: auto; }
    .year-range-dual input[type="range"]::-moz-range-thumb { pointer-events: auto; }
    #year-from { z-index: 3; }
    #year-to { z-index: 4; }
    input[type="range"] {
      width: 100%;
      padding: 0;
      height: 24px;
      background: transparent;
      border: 0;
      accent-color: var(--accent);
      cursor: pointer;
    }
    footer { color: var(--muted); font-size: 12px; text-align: center; padding: 20px 0 30px; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>DOAJ Journals Dashboard</h1>
      <div class="muted">Live snapshot (hourly) from DOAJ CSV source</div>
    </div>
    <div style="flex:1"></div>
    <div class="muted" id="meta-info">Loading…</div>
  </header>
  <div id="status-banner" class="status-banner hidden"></div>

  <div class="card-grid" id="kpi-cards">
    <div class="card"><div class="label">Journals</div><div class="value" id="kpi-journals">–</div></div>
    <div class="card"><div class="label">Country</div><div class="value" id="kpi-countries">–</div></div>
    <div class="card"><div class="label">Articles</div><div class="value" id="kpi-articles">–</div></div>
    <div class="card"><div class="label">Languages</div><div class="value" id="kpi-languages">–</div></div>
    <div class="card"><div class="label">No APC</div><div class="value" id="kpi-no-apc">–</div></div>
  </div>

  <div class="layout">
    <div class="panel filters">
      <h3>Filters</h3>
      <div class="filter-group">
        <label for="country">Country</label>
        <select id="country"><option value="">All</option></select>
      </div>
      <div class="filter-group">
        <label for="subject-filter">Subjects</label>
        <select id="subject-filter"><option value="">All</option></select>
      </div>
      <div class="filter-group">
        <label for="license">License Type</label>
        <select id="license"><option value="">All</option></select>
      </div>
      <div class="filter-group">
        <label for="apc">APC</label>
        <select id="apc">
          <option value="">All</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="author-retains">Author Retains Copyright</label>
        <select id="author-retains">
          <option value="">All</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="peer-review">Peer Review Type</label>
        <select id="peer-review">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="language">Languages</label>
        <select id="language">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="publisher">Publisher (text)</label>
        <input id="publisher" type="text" placeholder="contains…" />
      </div>
      <div class="filter-group">
        <label for="year-from">Created Year (horizontal range)</label>
        <div class="year-range-wrap">
          <span class="year-end" id="year-min-label">1900</span>
          <div class="year-range-dual">
            <input id="year-from" type="range" min="1900" max="2100" value="1900" />
            <input id="year-to" type="range" min="1900" max="2100" value="2100" />
          </div>
          <span class="year-end" id="year-max-label">2100</span>
        </div>
      </div>
      <button id="reset">Reset Filters</button>
    </div>

    <div class="charts">
      <div class="chart-row">
        <div class="chart-box" id="chart-country"></div>
        <div class="chart-box" id="chart-subjects"></div>
      </div>
      <div class="chart-row">
        <div class="chart-box" id="chart-license"></div>
        <div class="chart-box" id="chart-peer-review"></div>
      </div>
      <div class="chart-row">
        <div class="chart-box" id="chart-pid"></div>
        <div class="chart-box" id="chart-languages"></div>
      </div>
      <div class="chart-row">
        <div class="chart-box" id="chart-publishers"></div>
        <div class="chart-box" id="chart-timeline"></div>
      </div>
      <div class="chart-row single">
        <div class="chart-box map-box" id="chart-country-map"></div>
      </div>
    </div>
  </div>

  <div class="table-box">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
      <h3 style="margin:0;">Journals (first 50 of filtered)</h3>
      <div class="muted" id="table-count">–</div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Journal title</th>
          <th>Country of publisher</th>
          <th>Subject</th>
          <th>APC</th>
          <th>Article records</th>
          <th>Date of inclusion</th>
          <th>Last updated</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>

  <footer>Metadata is CC0. Dashboard is built from hourly DOAJ CSV snapshots.</footer>

  <script>
    const state = {
      records: [],
      filtered: [],
      aggregates: {},
      meta: {},
      yearBounds: null
    };
    const NOT_AVAILABLE = 'Not available';
    const countryNameFormatter = (typeof Intl !== 'undefined' && typeof Intl.DisplayNames !== 'undefined')
      ? new Intl.DisplayNames([navigator.language || 'en', 'en'], { type: 'region' })
      : null;

    function setStatus(message) {
      const el = document.getElementById('status-banner');
      if (!message) {
        el.textContent = '';
        el.classList.add('hidden');
        return;
      }
      el.textContent = message;
      el.classList.remove('hidden');
    }

    function formatNumber(n) {
      return n === undefined || n === null ? "–" : n.toLocaleString();
    }

    function formatDate(iso) {
      if (!iso) return "–";
      const d = new Date(iso);
      return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function toValueList(value) {
      if (value === null || value === undefined) return [];
      if (Array.isArray(value)) return value.flatMap(toValueList).filter(Boolean);
      if (typeof value === 'object') {
        for (const key of ['scheme', 'service', 'name', 'term', 'type', 'id']) {
          if (typeof value[key] === 'string' && value[key].trim()) return [value[key].trim()];
        }
        return [];
      }
      const text = String(value).trim();
      if (!text) return [];
      const parts = text.split(/[|;,\n]+/).map(part => part.trim()).filter(Boolean);
      return [...new Set(parts)];
    }

    function normalizeSimpleTerm(value) {
      if (!value) return '';
      const cleaned = String(value).replace(/\s+/g, ' ').trim();
      if (!cleaned) return '';
      if (cleaned === cleaned.toLowerCase() || cleaned === cleaned.toUpperCase()) {
        return titleCase(cleaned);
      }
      return cleaned;
    }

    function getSimpleTerms(value) {
      const terms = toValueList(value).map(normalizeSimpleTerm).filter(Boolean);
      return [...new Set(terms)];
    }

    function normalizeForMatch(value) {
      const folded = String(value).normalize('NFKD').replace(/[\u0300-\u036f]/g, '');
      return folded.toLowerCase().replace(/[^a-z0-9\s]/g, ' ').replace(/\s+/g, ' ').trim();
    }

    function smartTitle(value) {
      const cleaned = String(value);
      if (cleaned === cleaned.toLowerCase() || cleaned === cleaned.toUpperCase()) {
        return titleCase(cleaned);
      }
      return cleaned;
    }

    function formatPidScheme(value) {
      const canonical = normalizePidSchemeTerm(value);
      return canonical || NOT_AVAILABLE;
    }

    function normalizePidSchemeTerm(value) {
      if (!value) return '';
      const cleaned = String(value).replace(/\s+/g, ' ').trim();
      if (!cleaned) return '';
      const normalized = normalizeForMatch(cleaned);
      const cleanedLower = cleaned.toLowerCase();
      if (cleanedLower.includes('удк')) return 'UDC';

      const aliases = [
        { re: /\bcross\s*ref\b|\bcrossref\b|\bcrossreff\b|\bcrossref doi\b|\bdoi.*crossref\b|\bcrossref.*doi\b/, canonical: 'CrossRef' },
        { re: /\bdata\s*cite\b|\bdatacite\b|\bdatacitee\b/, canonical: 'DataCite' },
        { re: /\borcid\b/, canonical: 'ORCID' },
        { re: /\bpmcid\b/, canonical: 'PMCID' },
        { re: /\bpmid\b/, canonical: 'PMID' },
        { re: /\bissn\b/, canonical: 'ISSN' },
        { re: /\bdoi\b/, canonical: 'DOI' },
        { re: /\bark\b/, canonical: 'ARK' },
        { re: /\burns?\b/, canonical: 'URN' },
        { re: /\bhandles?\b/, canonical: 'Handle' },
        { re: /\bdors?\b|\bdigital object recognizer\b/, canonical: 'DOR' },
        { re: /\bpurls?\b/, canonical: 'PURL' },
        { re: /\bcoden\b/, canonical: 'CODEN' },
        { re: /\budc\b|\budk\b|\buniversal decimal classification\b|\bудк\b/, canonical: 'UDC' },
        { re: /\bedn\b/, canonical: 'EDN' },
        { re: /\buri\b|\bdc identifier uri\b/, canonical: 'URI' },
        { re: /\bnbn\b/, canonical: 'NBN' },
        { re: /\bgicid\b/, canonical: 'GICID' },
        { re: /\bbiblid\b/, canonical: 'BIBLID' },
        { re: /\bcu\s*id\b/, canonical: 'CU-ID' },
        { re: /\bcrossmark\b/, canonical: 'Crossmark' },
        { re: /\bcstr\b/, canonical: 'CSTR' },
        { re: /\bjel\b/, canonical: 'JEL' },
        { re: /\boai\b/, canonical: 'OAI' },
        { re: /\bqr\b.*\bcode\b/, canonical: 'QR Code' },
        { re: /\bpid\b/, canonical: 'PID' },
        { re: /\bedu\s*nl\b/, canonical: 'Edu.nl' }
      ];

      for (const alias of aliases) {
        if (alias.re.test(normalized)) return alias.canonical;
      }

      if (/https?:\/\/|www\./.test(cleanedLower)) return 'URL';

      return smartTitle(cleaned);
    }

    function getPidSchemes(value) {
      const terms = toValueList(value).map(normalizePidSchemeTerm).filter(Boolean);
      return [...new Set(terms)];
    }

    function normalizePreservationTerm(value) {
      if (!value) return '';
      const cleaned = String(value).replace(/\s+/g, ' ').trim().replace(/[ .;,:-]+$/g, '');
      if (!cleaned) return '';
      const normalized = normalizeForMatch(cleaned);

      const aliases = [
        { re: /\bajol\b|\bafrican journals? online\b/, canonical: 'African Journals Online' },
        { re: /\bzenodo\b|\bzenedo\b|\bzenodoo\b/, canonical: 'Zenodo' },
        { re: /\bclockss\b/, canonical: 'CLOCKSS' },
        { re: /\blockss\b/, canonical: 'LOCKSS' },
        { re: /\bpkp\b.*\bpn\b|\bpkp preservation network\b/, canonical: 'PKP Preservation Network' },
        { re: /\bpkp\s*pln\b|\bpublic knowledge project pln\b/, canonical: 'PKP Preservation Network' },
        { re: /\bportico\b/, canonical: 'Portico' },
        { re: /\bpubmed central\b|\bpmc\b/, canonical: 'PubMed Central' },
        { re: /\binternet archive\b/, canonical: 'Internet Archive' },
        { re: /\bweb archive\b|\barchive org\b/, canonical: 'Internet Archive' },
        { re: /\bcariniana\b/, canonical: 'Cariniana Network' },
        { re: /\bscholars?\s*portal\b/, canonical: 'Scholars Portal' },
        { re: /\bhrcak\b|\bhr cak\b|\bhr ak\b|portal of (croatian|scientific journals of croatia)/, canonical: 'Hrcak Portal of Croatian Scientific Journals' },
        { re: /\be\s*library\b|\belibrary\b|russian electronic scientific library/, canonical: 'eLIBRARY.RU' },
        { re: /\bmagiran\b/, canonical: 'Magiran' },
        { re: /\bnoormags?\b/, canonical: 'Noormags' },
        { re: /\bisc\b|\bislamic world science citation center\b/, canonical: 'Islamic World Science Citation Center' },
        { re: /\bscindeks\b|serbian citation index/, canonical: 'SCIndeks (Serbian Citation Index)' },
        { re: /\bcross\s*ref\b|\bcrossref\b/, canonical: 'CrossRef' },
        { re: /\bkoreamed synapse\b/, canonical: 'KoreaMed Synapse' },
        { re: /\bkoreamed\b/, canonical: 'KoreaMed' },
        { re: /\bceeol\b/, canonical: 'CEEOL' },
        { re: /\bcines\b/, canonical: 'CINES' },
        { re: /\braco\b/, canonical: 'RACO' },
        { re: /\bscience\s*central\b/, canonical: 'Science Central' },
        { re: /\bkorea\s*med\b/, canonical: 'KoreaMed' },
        { re: /\beuro\s*pub\b/, canonical: 'Europub' },
        { re: /\bportal\s*garuda\b/, canonical: 'Garuda' },
        { re: /\bsynapse\b/, canonical: 'KoreaMed Synapse' },
        { re: /\bscholar\b.*\bportal\b/, canonical: 'Scholars Portal' },
        { re: /\buniversity computing centre srce\b/, canonical: 'Hrcak Portal of Croatian Scientific Journals' },
        { re: /\bgoogle scholar\b/, canonical: 'Google Scholar' },
        { re: /\bsid\b/, canonical: 'SID' },
        { re: /\bniscpr online periodicals repository\b/, canonical: 'NIScPR Online Periodicals Repository' },
        { re: /\bin[- ]?house archiving\b/, canonical: 'In-house Archiving' },
        { re: /\bjournal'?s?\s+website\b|\bjournal\s+s?\s+website\b|\bjournal\s+website\b|\bwebsite of the journal\b|\barchived in the journal\b|\bissues of the journal\b/, canonical: 'Journal Website' },
        { re: /\bnational digital archives of iranian scholarly journals\b/, canonical: 'National Digital Archives of Iranian Scholarly Journals' },
        { re: /\be\s*depot\b/, canonical: 'E-Depot' },
        { re: /\bnational library of the netherlands\b|\bkoninklijke bibliotheek\b|\bkb\b/, canonical: 'KB National Library of the Netherlands' }
      ];

      for (const alias of aliases) {
        if (alias.re.test(normalized)) return alias.canonical;
      }

      if (/https?:\/\/|www\./i.test(cleaned)) {
        const urlAliases = [
          { re: /\bhrcak\b/, canonical: 'Hrcak Portal of Croatian Scientific Journals' },
          { re: /\belibrary\b|\bru\b/, canonical: 'eLIBRARY.RU' },
          { re: /\bkoreamed\b/, canonical: 'KoreaMed' },
          { re: /\bscholar\b/, canonical: 'Google Scholar' },
          { re: /\barchive\b|\bjournal\b|\brepository\b/, canonical: 'Journal Website' }
        ];
        for (const alias of urlAliases) {
          if (alias.re.test(normalized)) return alias.canonical;
        }
        return 'Journal Website';
      }

      const paren = cleaned.match(/\(([^)]+)\)/);
      if (paren) {
        const inner = paren[1].replace(/\s+/g, ' ').trim();
        if (inner.length > 4 && inner.includes(' ')) return inner;
      }

      return smartTitle(cleaned);
    }

    function getPreservationTerms(value) {
      const terms = toValueList(value).map(normalizePreservationTerm).filter(Boolean);
      return [...new Set(terms)];
    }

    function normalizePeerReviewTerm(value) {
      if (!value) return '';
      const cleaned = String(value).replace(/\s+/g, ' ').trim();
      if (!cleaned) return '';
      const normalized = normalizeForMatch(cleaned);

      const aliases = [
        { re: /\bpartial\b.*\bdouble\b.*\b(anonymous|blind)\b|\bdouble\b.*\b(anonymous|blind)\b/, canonical: 'Double anonymous peer review' },
        { re: /\btriple\b.*\b(anonymous|blind)\b/, canonical: 'Triple anonymous peer review' },
        { re: /\bopen peer commentary\b|\bopen\b.*\bpeer\b.*\breview\b/, canonical: 'Open peer review' },
        { re: /\bpost publication\b.*\bpeer\b.*\breview\b/, canonical: 'Post-publication peer review' },
        { re: /\bcrowd\b.*\breview\b/, canonical: 'Crowd review' },
        { re: /\bcommittee\b.*\breview\b/, canonical: 'Committee review' },
        { re: /\b(editorial review|collaborative editorial)\b/, canonical: 'Editorial review' },
        { re: /\b(single|anonymous|blind)\b.*\bpeer\b.*\breview\b|\banonymous peer review\b/, canonical: 'Anonymous peer review' },
        { re: /\bpeer\b.*\breview\b/, canonical: 'Peer review' }
      ];

      for (const alias of aliases) {
        if (alias.re.test(normalized)) return alias.canonical;
      }
      return smartTitle(cleaned);
    }

    function getPeerReviewTerms(value) {
      const terms = toValueList(value).map(normalizePeerReviewTerm).filter(Boolean);
      return [...new Set(terms)];
    }

    function normalizeDepositPolicyTerm(value) {
      if (!value) return '';
      const cleaned = String(value).replace(/\s+/g, ' ').trim().replace(/[ .;,:-]+$/g, '');
      if (!cleaned) return '';
      const normalized = normalizeForMatch(cleaned);

      const aliases = [
        { re: /\bopen policy finder\b|\bsherpa\s*romeo\b/, canonical: 'Open Policy Finder' },
        { re: /\bdiadorim\b/, canonical: 'Diadorim' },
        { re: /\bdulcinea\b/, canonical: 'Dulcinea' },
        { re: /\bmir\s*bel\b|\bmirabel\b/, canonical: 'Mir@bel' },
        { re: /\bmalena\b/, canonical: 'Malena' },
        { re: /\baura\b/, canonical: 'AURA' },
        { re: /\bdergi\s*park\b/, canonical: 'DergiPark' },
        { re: /\bgaruda\b|\bgarba rujukan digital\b/, canonical: 'Garuda' },
        { re: /\b(publisher|publishers|pulisher|pulishers)\b.*\b(site|website)\b|\b(publisher|publishers|pulisher|pulishers)\b.*\bown\b.*\b(site|website)\b/, canonical: "Publisher's own site" },
        { re: /\bjournal\b.*\bown\b.*\b(site|website)\b|\bjournal own website\b/, canonical: "Journal's own site" },
        { re: /\bjournal\b.*\b(site|website)\b/, canonical: 'Journal website' },
        { re: /\bpreprint\b.*\bpostprint\b.*\bpolicy\b/, canonical: 'Preprint and postprint policy' },
        { re: /\bpre[- ]?print\b.*\bpost[- ]?print\b.*\bdeposition\b.*\bpolicy\b/, canonical: 'Preprint and postprint policy' },
        { re: /\bself\b.*\barchiving\b/, canonical: 'Self-archiving policy' },
        { re: /\brepository\b.*\bpolicy\b/, canonical: 'Repository policy' },
        { re: /\bin[- ]?house\b.*\brepository\b/, canonical: 'In-house repository' },
        { re: /\bcopyright\b/, canonical: 'Copyright notice' },
        { re: /\bauthors?\b.*\brights?\b/, canonical: "Authors' rights" },
        { re: /\bauthors?\b.*\bpersonal\b.*\binstitutional\b.*\brepositor/, canonical: "Authors' personal and institutional repositories" },
        { re: /\binstruction(s)?\s+to\s+authors\b|\binstructions?\s+for\s+authors\b/, canonical: 'Instructions for authors' },
        { re: /\bopen access statement\b|\bopen access policy\b/, canonical: 'Open access policy' },
        { re: /\binstitutional\b.*\brepository\b/, canonical: 'Institutional repository' },
        { re: /\bbrill\b/, canonical: 'Brill.com' },
        { re: /\bour own site\b/, canonical: "Publisher's own site" },
        { re: /\bpublic and\s+or commercial subject based repositories\b/, canonical: 'Public and/or commercial subject-based repositories' },
        { re: /\bkarger permits authors of open access articles\b/, canonical: 'Karger policy statement' },
        { re: /\bvcgate\b/, canonical: 'VCgate' },
        { re: /\bvjol\b/, canonical: 'VJOL' },
        { re: /\bscpj\b/, canonical: 'SCPJ' },
        { re: /\bojs\s*\/?\s*pkp\b/, canonical: 'OJS/PKP' },
        { re: /\blockss\b/, canonical: 'LOCKSS' },
        { re: /\bcross\s*ref\b|\bcrossref\b/, canonical: 'CrossRef' }
      ];

      for (const alias of aliases) {
        if (alias.re.test(normalized)) return alias.canonical;
      }

      if (/https?:\/\/|www\./i.test(cleaned)) {
        const urlAliases = [
          { re: /\bdergi\s*park\b/, canonical: 'DergiPark' },
          { re: /\bsherpa\b|\bromeo\b|\bopen policy finder\b/, canonical: 'Open Policy Finder' },
          { re: /\bcreative\s*commons\b/, canonical: 'Creative Commons' },
          { re: /\barxiv\b/, canonical: 'arXiv' },
          { re: /\bzenodo\b/, canonical: 'Zenodo' },
          { re: /\bfairsharing\b/, canonical: 'FAIRsharing' }
        ];
        for (const alias of urlAliases) {
          if (alias.re.test(normalized)) return alias.canonical;
        }
        return 'Journal website';
      }
      if (/\bpublisher\b/.test(normalized) && /\b(site|website)\b/.test(normalized)) return "Publisher's own site";
      if (/\bjournal\b/.test(normalized) && /\b(site|website)\b/.test(normalized)) return 'Journal website';
      return smartTitle(cleaned);
    }

    function getDepositPolicyTerms(value) {
      const terms = toValueList(value).map(normalizeDepositPolicyTerm).filter(Boolean);
      return [...new Set(terms)];
    }

    function titleCase(value) {
      return String(value)
        .toLowerCase()
        .replace(/\b([a-z])/g, ch => ch.toUpperCase());
    }

    function formatCountry(country) {
      if (!country) return NOT_AVAILABLE;
      const raw = String(country).trim();
      const cleaned = raw.replace(/_/g, ' ');
      const upper = cleaned.toUpperCase();

      if (/^[A-Z]{2}$/.test(upper) && countryNameFormatter) {
        const resolved = countryNameFormatter.of(upper);
        if (resolved && resolved !== upper) return resolved;
      }

      if (/^[A-Z][A-Z\s-]{3,}$/.test(cleaned)) {
        return titleCase(cleaned);
      }

      return cleaned;
    }

    function shortLabel(text, maxLen = 45) {
      if (!text) return '—';
      const value = String(text);
      return value.length <= maxLen ? value : `${value.slice(0, maxLen - 3)}...`;
    }

    function getCreatedYear(record) {
      if (!record || !record.created_date) return null;
      const year = new Date(record.created_date).getUTCFullYear();
      return Number.isNaN(year) ? null : year;
    }

    function getArticleRecords(record) {
      if (!record) return null;
      const raw = record.article_records;
      if (raw === null || raw === undefined || raw === '') return null;
      const num = Number(raw);
      if (Number.isFinite(num)) return Math.trunc(num);
      const match = String(raw).replace(/,/g, '').match(/-?\d+/);
      return match ? Number(match[0]) : null;
    }

    function isOverOneMonth(record) {
      if (!record || !record.created_date) return false;
      const created = new Date(record.created_date);
      if (Number.isNaN(created.getTime())) return false;
      return Date.now() - created.getTime() > (30 * 24 * 60 * 60 * 1000);
    }

    function sumArticleRecords(records) {
      return records.reduce((sum, r) => {
        const value = getArticleRecords(r);
        return sum + (value === null ? 0 : value);
      }, 0);
    }

    function sortedEntries(counterObj, limit) {
      const entries = Object.entries(counterObj).sort((a, b) => b[1] - a[1]);
      return typeof limit === 'number' ? entries.slice(0, limit) : entries;
    }

    function countTermFrequency(records, termExtractor, includeNotAvailable = false) {
      const counts = {};
      for (const record of records) {
        const terms = [...new Set((termExtractor(record) || []).filter(Boolean))];
        if (!terms.length) {
          if (includeNotAvailable) {
            counts[NOT_AVAILABLE] = (counts[NOT_AVAILABLE] || 0) + 1;
          }
          continue;
        }
        for (const term of terms) {
          counts[term] = (counts[term] || 0) + 1;
        }
      }
      return counts;
    }

    function renderHorizontalBarChart(targetId, title, entries, opts = {}) {
      if (!entries.length) {
        Plotly.newPlot(
          targetId,
          [],
          {
            title,
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: '#282624' },
            xaxis: { visible: false },
            yaxis: { visible: false },
            annotations: [{ text: 'No data yet', showarrow: false, xref: 'paper', yref: 'paper', x: 0.5, y: 0.5 }]
          },
          { displayModeBar: false }
        );
        return;
      }

      const labelFormatter = opts.labelFormatter || (v => v);
      const labels = entries.map(d => labelFormatter(d[0]));
      const values = entries.map(d => d[1]);
      const colors = opts.colors || labels.map(() => (opts.color || '#3A5959'));

      Plotly.newPlot(
        targetId,
        [{
          type: 'bar',
          orientation: 'h',
          x: values.slice().reverse(),
          y: labels.slice().reverse(),
          marker: { color: colors.slice().reverse() }
        }],
        {
          title,
          margin: { l: opts.leftMargin || 280, r: 12, t: 46, b: 48 },
          paper_bgcolor: 'rgba(0,0,0,0)',
          plot_bgcolor: 'rgba(0,0,0,0)',
          font: { color: '#282624' },
          yaxis: { automargin: true, ticklabelstandoff: 6 }
        },
        { displayModeBar: false }
      );
    }

    function syncYearLabels() {
      const minEl = document.getElementById('year-min-label');
      const maxEl = document.getElementById('year-max-label');
      if (!state.yearBounds) {
        minEl.textContent = '—';
        maxEl.textContent = '—';
        return;
      }
      minEl.textContent = String(state.yearBounds.min);
      maxEl.textContent = String(state.yearBounds.max);
    }

    function setupYearRange() {
      const fromEl = document.getElementById('year-from');
      const toEl = document.getElementById('year-to');
      const years = state.records.map(getCreatedYear).filter(y => y !== null);

      if (!years.length) {
        state.yearBounds = null;
        fromEl.disabled = true;
        toEl.disabled = true;
        fromEl.value = '';
        toEl.value = '';
        syncYearLabels();
        return;
      }

      const min = Math.min(...years);
      const max = Math.max(...years);
      state.yearBounds = { min, max };

      fromEl.disabled = false;
      toEl.disabled = false;
      fromEl.min = String(min);
      fromEl.max = String(max);
      toEl.min = String(min);
      toEl.max = String(max);

      if (!fromEl.value || Number.isNaN(parseInt(fromEl.value, 10))) fromEl.value = String(min);
      if (!toEl.value || Number.isNaN(parseInt(toEl.value, 10))) toEl.value = String(max);
      if (parseInt(fromEl.value, 10) < min) fromEl.value = String(min);
      if (parseInt(fromEl.value, 10) > max) fromEl.value = String(max);
      if (parseInt(toEl.value, 10) < min) toEl.value = String(min);
      if (parseInt(toEl.value, 10) > max) toEl.value = String(max);
      if (parseInt(fromEl.value, 10) > parseInt(toEl.value, 10)) fromEl.value = toEl.value;

      syncYearLabels();
    }

    function resetYearRange() {
      const fromEl = document.getElementById('year-from');
      const toEl = document.getElementById('year-to');
      if (!state.yearBounds) {
        fromEl.value = '';
        toEl.value = '';
      } else {
        fromEl.value = String(state.yearBounds.min);
        toEl.value = String(state.yearBounds.max);
      }
      syncYearLabels();
    }

    async function loadJsonOrNull(path) {
      try {
        const res = await fetch(path, { cache: 'no-store' });
        if (!res.ok) return null;
        return await res.json();
      } catch (_err) {
        return null;
      }
    }

    async function loadData() {
      const [journalsRes, aggRes, metaRes] = await Promise.all([
        loadJsonOrNull('data/journals.json'),
        loadJsonOrNull('data/aggregates.json'),
        loadJsonOrNull('data/meta.json')
      ]);

      if (!Array.isArray(journalsRes) || journalsRes.length === 0) {
        state.records = [];
        state.filtered = [];
        state.aggregates = aggRes || {};
        state.meta = metaRes || {};
        setStatus('Data is not available yet. Trigger the "Fetch DOAJ journals (hourly)" GitHub Action, then refresh this page.');
        renderAll();
        return;
      }

      state.records = journalsRes;
      state.filtered = journalsRes;
      state.aggregates = aggRes || {};
      state.meta = metaRes || {};
      setStatus('');
      populateFilters();
      renderAll();
    }

    function populateFilters() {
      const countries = Array.from(new Set(state.records.map(r => r.country).filter(Boolean)))
        .sort((a, b) => formatCountry(a).localeCompare(formatCountry(b)));
      const subjects = Array.from(new Set(state.records.flatMap(r => toValueList(r.subject_terms))))
        .sort((a, b) => String(a).localeCompare(String(b)));
      const licenses = Array.from(new Set(state.records.flatMap(r => toValueList(r.license_type))))
        .sort((a, b) => String(a).localeCompare(String(b)));
      const peerReviews = Array.from(new Set(state.records.flatMap(r => getPeerReviewTerms(r.peer_review_type))))
        .sort((a, b) => String(a).localeCompare(String(b)));
      const languages = Array.from(new Set(state.records.flatMap(r => getSimpleTerms(r.language))))
        .sort((a, b) => String(a).localeCompare(String(b)));

      const countrySelect = document.getElementById('country');
      countrySelect.length = 1;
      countries.forEach(country => {
        const opt = document.createElement('option');
        opt.value = country;
        opt.textContent = formatCountry(country);
        countrySelect.appendChild(opt);
      });

      const subjectSelect = document.getElementById('subject-filter');
      subjectSelect.length = 1;
      subjects.forEach(subject => {
        const opt = document.createElement('option');
        opt.value = subject;
        opt.textContent = subject;
        subjectSelect.appendChild(opt);
      });

      const licenseSelect = document.getElementById('license');
      licenseSelect.length = 1;
      licenses.forEach(license => {
        const opt = document.createElement('option');
        opt.value = license;
        opt.textContent = license;
        licenseSelect.appendChild(opt);
      });

      const peerReviewSelect = document.getElementById('peer-review');
      peerReviewSelect.length = 1;
      peerReviews.forEach(review => {
        const opt = document.createElement('option');
        opt.value = review;
        opt.textContent = review;
        peerReviewSelect.appendChild(opt);
      });

      const languageSelect = document.getElementById('language');
      languageSelect.length = 1;
      languages.forEach(language => {
        const opt = document.createElement('option');
        opt.value = language;
        opt.textContent = language;
        languageSelect.appendChild(opt);
      });

      setupYearRange();
    }

    function applyFilters() {
      const country = document.getElementById('country').value;
      const subjectFilter = document.getElementById('subject-filter').value;
      const license = document.getElementById('license').value;
      const apc = document.getElementById('apc').value;
      const author = document.getElementById('author-retains').value;
      const peerReview = document.getElementById('peer-review').value;
      const language = document.getElementById('language').value;
      const publisher = document.getElementById('publisher').value.trim().toLowerCase();
      const yearFrom = parseInt(document.getElementById('year-from').value, 10);
      const yearTo = parseInt(document.getElementById('year-to').value, 10);

      state.filtered = state.records.filter(r => {
        if (country && r.country !== country) return false;
        if (subjectFilter && !toValueList(r.subject_terms).includes(subjectFilter)) return false;
        if (license && !toValueList(r.license_type).includes(license)) return false;
        if (apc === 'yes' && r.apc_has !== true) return false;
        if (apc === 'no' && r.apc_has !== false) return false;
        if (author === 'yes' && r.author_retains !== true) return false;
        if (author === 'no' && r.author_retains !== false) return false;
        if (peerReview && !getPeerReviewTerms(r.peer_review_type).includes(peerReview)) return false;
        if (language && !getSimpleTerms(r.language).includes(language)) return false;
        if (publisher && !(r.publisher || '').toLowerCase().includes(publisher)) return false;
        if (state.yearBounds && !Number.isNaN(yearFrom) && !Number.isNaN(yearTo)) {
          const usesYearNarrowing = yearFrom > state.yearBounds.min || yearTo < state.yearBounds.max;
          if (usesYearNarrowing) {
            const y = getCreatedYear(r);
            if (y === null) return false;
            if (y < yearFrom || y > yearTo) return false;
          }
        }
        return true;
      });
      renderAll();
    }

    function resetFilters() {
      document.querySelectorAll('.filters select').forEach(el => { el.value = ''; });
      document.querySelectorAll('.filters input[type="text"]').forEach(el => { el.value = ''; });
      resetYearRange();
      state.filtered = state.records;
      renderAll();
    }

    function renderKPIs() {
      const countries = new Set(state.filtered.map(r => r.country).filter(Boolean));
      const languages = new Set(state.filtered.flatMap(r => getSimpleTerms(r.language)));
      const noApc = state.filtered.filter(r => r.apc_has === false).length;

      document.getElementById('kpi-journals').textContent = formatNumber(state.filtered.length);
      document.getElementById('kpi-countries').textContent = formatNumber(countries.size);
      document.getElementById('kpi-articles').textContent = formatNumber(sumArticleRecords(state.filtered));
      document.getElementById('kpi-languages').textContent = formatNumber(languages.size);
      document.getElementById('kpi-no-apc').textContent = formatNumber(noApc);

      const metaText = `Source last updated: ${formatDate(state.meta.source_last_updated_max)}`;
      document.getElementById('meta-info').textContent = metaText;
    }

    function renderCharts() {
      if (!state.filtered.length) {
        renderEmptyCharts();
        return;
      }

      const countryCounts = {};
      for (const record of state.filtered) {
        if (record.country) countryCounts[record.country] = (countryCounts[record.country] || 0) + 1;
      }
      const topCountries = sortedEntries(countryCounts, 10).map(([country, count]) => [formatCountry(country), count]);
      renderHorizontalBarChart('chart-country', 'Top 10 countries', topCountries, { leftMargin: 260, color: '#3A5959' });

      const subjectCounts = countTermFrequency(state.filtered, r => toValueList(r.subject_terms));
      const topSubjects = sortedEntries(subjectCounts, 10).map(([term, count]) => [shortLabel(term, 60), count]);
      renderHorizontalBarChart('chart-subjects', 'Top 10 subjects', topSubjects, { leftMargin: 320, color: '#FA9A87' });

      const licenseCounts = countTermFrequency(state.filtered, r => toValueList(r.license_type));
      const topLicenses = sortedEntries(licenseCounts, 12).map(([term, count]) => [shortLabel(term, 56), count]);
      renderHorizontalBarChart('chart-license', 'License usage', topLicenses, { leftMargin: 300, color: '#FD5A3B' });

      const peerCounts = countTermFrequency(state.filtered, r => getPeerReviewTerms(r.peer_review_type), true);
      const topPeer = sortedEntries(peerCounts, 5);
      const peerColors = topPeer.map(([label]) => (label === NOT_AVAILABLE ? '#982E0A' : '#47A178'));
      renderHorizontalBarChart(
        'chart-peer-review',
        'Top 5 peer-review type',
        topPeer.map(([label, count]) => [shortLabel(label, 56), count]),
        { leftMargin: 300, colors: peerColors }
      );

      const pidCounts = countTermFrequency(state.filtered, r => getPidSchemes(r.pid_scheme), true);
      const topPid = sortedEntries(pidCounts, 5);
      const pidColors = topPid.map(([label]) => (label === NOT_AVAILABLE ? '#982E0A' : '#3A5959'));
      renderHorizontalBarChart(
        'chart-pid',
        'Top 5 PID scheme',
        topPid.map(([label, count]) => [shortLabel(formatPidScheme(label), 56), count]),
        { leftMargin: 300, colors: pidColors }
      );

      const languageCounts = countTermFrequency(state.filtered, r => getSimpleTerms(r.language));
      const topLanguages = sortedEntries(languageCounts, 10).map(([term, count]) => [shortLabel(term, 56), count]);
      renderHorizontalBarChart('chart-languages', 'Top 10 languages', topLanguages, { leftMargin: 280, color: '#A3C386' });

      const publisherCounts = {};
      for (const record of state.filtered) {
        const publisher = (record.publisher || '').trim();
        if (!publisher) continue;
        publisherCounts[publisher] = (publisherCounts[publisher] || 0) + 1;
      }
      const topPublishers = sortedEntries(publisherCounts, 10).map(([name, count]) => [shortLabel(name, 60), count]);
      renderHorizontalBarChart('chart-publishers', 'Top 10 publishers', topPublishers, { leftMargin: 300, color: '#3A5959' });

      const timelineCounts = {};
      for (const record of state.filtered) {
        if (!record.created_date) continue;
        const date = new Date(record.created_date);
        if (Number.isNaN(date.getTime())) continue;
        const monthKey = `${date.getUTCFullYear()}-${String(date.getUTCMonth() + 1).padStart(2, '0')}`;
        timelineCounts[monthKey] = (timelineCounts[monthKey] || 0) + 1;
      }
      const timelineKeys = Object.keys(timelineCounts).sort();
      Plotly.newPlot(
        'chart-timeline',
        [{
          type: 'scatter',
          mode: 'lines+markers',
          x: timelineKeys.map(k => `${k}-01`),
          y: timelineKeys.map(k => timelineCounts[k]),
          line: { color: '#47A178', width: 2 }
        }],
        {
          title: 'Timeline of journals added to DOAJ',
          margin: { l: 48, r: 12, t: 46, b: 48 },
          paper_bgcolor: 'rgba(0,0,0,0)',
          plot_bgcolor: 'rgba(0,0,0,0)',
          font: { color: '#282624' },
          xaxis: { type: 'date', tickformat: '%b %Y' }
        },
        { displayModeBar: false }
      );

      const mapEntries = sortedEntries(countryCounts);
      const maxCountryCount = Math.max(...mapEntries.map(([, count]) => count), 1);
      Plotly.newPlot(
        'chart-country-map',
        [{
          type: 'scattergeo',
          mode: 'markers',
          locationmode: 'country names',
          locations: mapEntries.map(([country]) => formatCountry(country)),
          text: mapEntries.map(([country, count]) => `${formatCountry(country)}: ${formatNumber(count)} journals`),
          hovertemplate: '%{text}<extra></extra>',
          marker: {
            color: '#47A178',
            opacity: 0.75,
            line: { color: '#282624', width: 0.5 },
            size: mapEntries.map(([, count]) => 8 + Math.sqrt(count / maxCountryCount) * 34)
          }
        }],
        {
          title: 'Country of publishers (bubble size = journals)',
          margin: { l: 10, r: 10, t: 46, b: 10 },
          paper_bgcolor: 'rgba(0,0,0,0)',
          geo: {
            showframe: false,
            showcoastlines: true,
            coastlinecolor: '#D7D2CE',
            showcountries: true,
            countrycolor: '#D7D2CE',
            showland: true,
            landcolor: '#FFFFFF',
            bgcolor: 'rgba(0,0,0,0)',
            projection: { type: 'natural earth' }
          }
        },
        { displayModeBar: false }
      );
    }

    function renderEmptyCharts() {
      const emptyCharts = [
        ['chart-country', 'Top 10 countries'],
        ['chart-subjects', 'Top 10 subjects'],
        ['chart-license', 'License usage'],
        ['chart-peer-review', 'Top 5 peer-review type'],
        ['chart-pid', 'Top 5 PID scheme'],
        ['chart-languages', 'Top 10 languages'],
        ['chart-publishers', 'Top 10 publishers'],
        ['chart-timeline', 'Timeline of journals added to DOAJ']
      ];
      emptyCharts.forEach(([id, title]) => renderHorizontalBarChart(id, title, []));

      Plotly.newPlot(
        'chart-country-map',
        [],
        {
          title: 'Country of publishers (bubble size = journals)',
          paper_bgcolor: 'rgba(0,0,0,0)',
          geo: { showframe: false, showcoastlines: true, showcountries: true, showland: true },
          annotations: [{ text: 'No data yet', showarrow: false, x: 0.5, y: 0.5, xref: 'paper', yref: 'paper' }]
        },
        { displayModeBar: false }
      );
    }

    function renderTable() {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';

      const rows = state.filtered.slice(0, 50);
      document.getElementById('table-count').textContent = `${rows.length} shown of ${state.filtered.length} filtered`;
      if (!rows.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 7;
        td.className = 'muted';
        td.textContent = 'No journal data available yet.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      for (const record of rows) {
        const tr = document.createElement('tr');

        const titleCell = document.createElement('td');
        const titleText = record.title || NOT_AVAILABLE;
        const linkUrl = (record.doaj_url || '').trim();
        if (linkUrl && /^https?:\/\//i.test(linkUrl) && record.title) {
          const link = document.createElement('a');
          link.className = 'table-link';
          link.href = linkUrl;
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.textContent = titleText;
          titleCell.appendChild(link);
        } else {
          titleCell.textContent = titleText;
        }
        tr.appendChild(titleCell);

        const countryCell = document.createElement('td');
        countryCell.textContent = formatCountry(record.country);
        tr.appendChild(countryCell);

        const subjectCell = document.createElement('td');
        const subjectTerms = toValueList(record.subject_terms);
        subjectCell.textContent = subjectTerms.length ? shortLabel(subjectTerms[0], 72) : NOT_AVAILABLE;
        tr.appendChild(subjectCell);

        const apcCell = document.createElement('td');
        if (record.apc_has === true || record.apc_has === false) {
          const badge = document.createElement('span');
          badge.className = `pill${record.apc_has ? '' : ' negative'}`;
          badge.textContent = record.apc_has ? 'Yes' : 'No';
          apcCell.appendChild(badge);
        } else {
          apcCell.textContent = NOT_AVAILABLE;
        }
        tr.appendChild(apcCell);

        const articleCell = document.createElement('td');
        const articleValue = getArticleRecords(record);
        articleCell.textContent = articleValue === null ? NOT_AVAILABLE : formatNumber(articleValue);
        if (isOverOneMonth(record)) {
          const overTag = document.createElement('span');
          overTag.className = 'pill warn';
          overTag.textContent = 'Over 1 month';
          articleCell.appendChild(overTag);
        }
        tr.appendChild(articleCell);

        const includedCell = document.createElement('td');
        includedCell.textContent = record.created_date ? formatDate(record.created_date) : NOT_AVAILABLE;
        tr.appendChild(includedCell);

        const updatedCell = document.createElement('td');
        updatedCell.textContent = record.last_updated ? formatDate(record.last_updated) : NOT_AVAILABLE;
        tr.appendChild(updatedCell);

        tbody.appendChild(tr);
      }
    }

    function renderAll() {
      renderKPIs();
      renderCharts();
      renderTable();
    }

    function wireEvents() {
      document.querySelectorAll('.filters select, .filters input[type="text"]').forEach(el => {
        el.addEventListener('change', applyFilters);
        el.addEventListener('keyup', ev => { if (ev.key === 'Enter') applyFilters(); });
      });
      const fromEl = document.getElementById('year-from');
      const toEl = document.getElementById('year-to');
      fromEl.addEventListener('input', () => {
        if (parseInt(fromEl.value, 10) > parseInt(toEl.value, 10)) {
          toEl.value = fromEl.value;
        }
        syncYearLabels();
        applyFilters();
      });
      toEl.addEventListener('input', () => {
        if (parseInt(toEl.value, 10) < parseInt(fromEl.value, 10)) {
          fromEl.value = toEl.value;
        }
        syncYearLabels();
        applyFilters();
      });
      document.getElementById('reset').addEventListener('click', resetFilters);
    }

    async function init() {
      try {
        wireEvents();
        await loadData();
      } catch (err) {
        console.error(err);
        state.records = [];
        state.filtered = [];
        state.meta = {};
        setStatus('Unable to load dashboard data. Check GitHub Actions logs and refresh.');
        renderAll();
      }
    }

    init();
  </script>
</body>
</html>
