<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DOAJ Journals Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700&family=Source+Sans+Pro:wght@400;600;700&family=Source+Code+Pro:wght@500&display=swap" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
  <style>
    :root {
      --bg: #F6F4F4;           /* light-grey */
      --card: #FFFFFF;         /* white */
      --muted: #5C5956;        /* dark-grey */
      --text: #282624;         /* warm-black */
      --accent: #FD5A3B;       /* grapefruit */
      --accent-2: #FA9A87;     /* salmon */
      --accent-3: #47A178;     /* mid-green */
      --border: #D7D2CE;       /* light border */
      --shadow: 0 10px 24px rgba(40, 38, 36, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Source Sans Pro', system-ui, -apple-system, sans-serif;
      background:
        radial-gradient(circle at 20% 20%, rgba(253,90,59,0.08), transparent 35%),
        radial-gradient(circle at 80% 0%, rgba(163,195,134,0.12), transparent 35%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      padding: 24px 28px 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: baseline;
    }
    h1 { margin: 0; font-size: 26px; letter-spacing: -0.4px; font-family: 'Spectral', 'Source Sans Pro', serif; }
    .muted { color: var(--muted); font-size: 14px; }
    .layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
      padding: 0 28px 40px;
    }
    @media (max-width: 960px) {
      .layout { grid-template-columns: 1fr; }
    }
    .panel, .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
    }
    .panel { padding: 18px; }
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin: 0 28px 18px;
    }
    .card {
      padding: 14px 16px;
    }
    .card .label { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; }
    .card .value { font-size: 24px; font-weight: 700; margin-top: 6px; }
    .filters h3 { margin: 0 0 12px; }
    .filter-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }
    label { font-weight: 600; font-size: 14px; }
    select, input, button {
      width: 100%;
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #FFFFFF;
      color: var(--text);
      font-size: 14px;
    }
    input::placeholder { color: #8C8681; }
    button {
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border: none;
      font-weight: 700;
      letter-spacing: 0.02em;
    }
    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 14px;
      padding: 0 28px;
    }
    .chart-box {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
      box-shadow: var(--shadow);
      min-height: 280px;
    }
    .chart-box.stack {
      grid-column: 1 / -1;
      min-height: 360px;
    }
    .table-box {
      margin: 18px 28px 40px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 14px;
      overflow-x: auto;
    }
    table { width: 100%; border-collapse: collapse; font-family: 'Source Sans Pro', system-ui, -apple-system, sans-serif; }
    th, td { text-align: left; padding: 8px 6px; border-bottom: 1px solid var(--border); }
    th { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.06em; }
    .pill { display: inline-block; padding: 3px 8px; border-radius: 999px; font-size: 12px; background: rgba(71,161,120,0.18); color: #2F6E52; }
    .pill.negative { background: rgba(253,90,59,0.18); color: #8F311C; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; background: #22c55e; }
    .status-banner {
      margin: 0 28px 14px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(253, 90, 59, 0.12);
      color: #7A2A18;
      font-size: 14px;
    }
    .status-banner.hidden { display: none; }
    .year-range-wrap { display: flex; flex-direction: column; gap: 8px; }
    .year-range-values {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      color: var(--muted);
    }
    input[type="range"] {
      width: 100%;
      padding: 0;
      height: 24px;
      background: transparent;
      border: 0;
      accent-color: var(--accent);
      cursor: pointer;
    }
    footer { color: var(--muted); font-size: 12px; text-align: center; padding: 20px 0 30px; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>DOAJ Journals Dashboard</h1>
      <div class="muted">Live snapshot (hourly) from DOAJ CSV source</div>
    </div>
    <div style="flex:1"></div>
    <div class="muted" id="meta-info">Loading…</div>
  </header>
  <div id="status-banner" class="status-banner hidden"></div>

  <div class="card-grid" id="kpi-cards">
    <div class="card"><div class="label">Total Journals</div><div class="value" id="kpi-total">–</div></div>
    <div class="card"><div class="label">Last Updated</div><div class="value" id="kpi-updated">–</div></div>
    <div class="card"><div class="label">APC (Yes)</div><div class="value" id="kpi-apc">–</div></div>
    <div class="card"><div class="label">Preservation (Yes)</div><div class="value" id="kpi-pres">–</div></div>
    <div class="card"><div class="label">PID Scheme (Yes)</div><div class="value" id="kpi-pid">–</div></div>
  </div>

  <div class="layout">
    <div class="panel filters">
      <h3>Filters</h3>
      <div class="filter-group">
        <label for="country">Country</label>
        <select id="country"><option value="">All</option></select>
      </div>
      <div class="filter-group">
        <label for="license">License Type</label>
        <select id="license"><option value="">All</option></select>
      </div>
      <div class="filter-group">
        <label for="apc">APC</label>
        <select id="apc">
          <option value="">All</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="author-retains">Author Retains Copyright</label>
        <select id="author-retains">
          <option value="">All</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="peer-review">Peer Review Type</label>
        <select id="peer-review">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="preservation">Preservation</label>
        <select id="preservation">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="deposit-policy">Deposit Policy Directory</label>
        <select id="deposit-policy">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="pid">PID Scheme</label>
        <select id="pid">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="language">Languages</label>
        <select id="language">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="publisher">Publisher (text)</label>
        <input id="publisher" type="text" placeholder="contains…" />
      </div>
      <div class="filter-group">
        <label for="subject">Subject (text)</label>
        <input id="subject" type="text" placeholder="contains…" />
      </div>
      <div class="filter-group">
        <label for="year-from">Created Year (horizontal range)</label>
        <div class="year-range-wrap">
          <input id="year-from" type="range" min="1900" max="2100" value="1900" />
          <input id="year-to" type="range" min="1900" max="2100" value="2100" />
          <div class="year-range-values">
            <span id="year-from-label">1900</span>
            <span id="year-to-label">2100</span>
          </div>
        </div>
      </div>
      <button id="reset">Reset Filters</button>
    </div>

    <div class="charts">
      <div class="chart-box stack" id="chart-country"></div>
      <div class="chart-box stack" id="chart-subjects"></div>
      <div class="chart-box" id="chart-license"></div>
      <div class="chart-box" id="chart-apc"></div>
      <div class="chart-box" id="chart-timeline"></div>
    </div>
  </div>

  <div class="table-box">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
      <h3 style="margin:0;">Journals (first 50 of filtered)</h3>
      <div class="muted" id="table-count">–</div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Publisher</th>
          <th>Country</th>
          <th>License</th>
          <th>APC</th>
          <th>Preservation</th>
          <th>PID</th>
          <th>Created</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>

  <footer>Metadata is CC0. Dashboard is built from hourly DOAJ CSV snapshots.</footer>

  <script>
    const state = {
      records: [],
      filtered: [],
      aggregates: {},
      meta: {},
      yearBounds: null
    };
    const NOT_AVAILABLE = 'Not available';
    const countryNameFormatter = (typeof Intl !== 'undefined' && typeof Intl.DisplayNames !== 'undefined')
      ? new Intl.DisplayNames([navigator.language || 'en', 'en'], { type: 'region' })
      : null;

    function setStatus(message) {
      const el = document.getElementById('status-banner');
      if (!message) {
        el.textContent = '';
        el.classList.add('hidden');
        return;
      }
      el.textContent = message;
      el.classList.remove('hidden');
    }

    function formatNumber(n) {
      return n === undefined || n === null ? "–" : n.toLocaleString();
    }

    function formatDate(iso) {
      if (!iso) return "–";
      const d = new Date(iso);
      return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function toValueList(value) {
      if (value === null || value === undefined) return [];
      if (Array.isArray(value)) return value.flatMap(toValueList).filter(Boolean);
      if (typeof value === 'object') {
        for (const key of ['scheme', 'service', 'name', 'term', 'type', 'id']) {
          if (typeof value[key] === 'string' && value[key].trim()) return [value[key].trim()];
        }
        return [];
      }
      const text = String(value).trim();
      if (!text) return [];
      const parts = text.split(/[|;,\n]+/).map(part => part.trim()).filter(Boolean);
      return [...new Set(parts)];
    }

    function normalizeSimpleTerm(value) {
      if (!value) return '';
      const cleaned = String(value).replace(/\s+/g, ' ').trim();
      if (!cleaned) return '';
      if (cleaned === cleaned.toLowerCase() || cleaned === cleaned.toUpperCase()) {
        return titleCase(cleaned);
      }
      return cleaned;
    }

    function getSimpleTerms(value) {
      const terms = toValueList(value).map(normalizeSimpleTerm).filter(Boolean);
      return [...new Set(terms)];
    }

    function normalizeForMatch(value) {
      return String(value).toLowerCase().replace(/[^a-z0-9\s]/g, ' ').replace(/\s+/g, ' ').trim();
    }

    function smartTitle(value) {
      const cleaned = String(value);
      if (cleaned === cleaned.toLowerCase() || cleaned === cleaned.toUpperCase()) {
        return titleCase(cleaned);
      }
      return cleaned;
    }

    function formatPidScheme(value) {
      const canonical = normalizePidSchemeTerm(value);
      return canonical || NOT_AVAILABLE;
    }

    function normalizePidSchemeTerm(value) {
      if (!value) return '';
      const cleaned = String(value).replace(/\s+/g, ' ').trim();
      if (!cleaned) return '';
      const normalized = normalizeForMatch(cleaned);
      const cleanedLower = cleaned.toLowerCase();
      if (cleanedLower.includes('удк')) return 'UDC';

      const aliases = [
        { re: /\bcross\s*ref\b|\bcrossref\b|\bcrossreff\b|\bcrossref doi\b|\bdoi.*crossref\b|\bcrossref.*doi\b/, canonical: 'CrossRef' },
        { re: /\bdata\s*cite\b|\bdatacite\b|\bdatacitee\b/, canonical: 'DataCite' },
        { re: /\borcid\b/, canonical: 'ORCID' },
        { re: /\bpmcid\b/, canonical: 'PMCID' },
        { re: /\bpmid\b/, canonical: 'PMID' },
        { re: /\bissn\b/, canonical: 'ISSN' },
        { re: /\bdoi\b/, canonical: 'DOI' },
        { re: /\bark\b/, canonical: 'ARK' },
        { re: /\burns?\b/, canonical: 'URN' },
        { re: /\bhandles?\b/, canonical: 'Handle' },
        { re: /\bdors?\b|\bdigital object recognizer\b/, canonical: 'DOR' },
        { re: /\bpurls?\b/, canonical: 'PURL' },
        { re: /\bcoden\b/, canonical: 'CODEN' },
        { re: /\budc\b|\budk\b|\buniversal decimal classification\b|\bудк\b/, canonical: 'UDC' },
        { re: /\bedn\b/, canonical: 'EDN' },
        { re: /\buri\b|\bdc identifier uri\b/, canonical: 'URI' },
        { re: /\bnbn\b/, canonical: 'NBN' },
        { re: /\bgicid\b/, canonical: 'GICID' },
        { re: /\bbiblid\b/, canonical: 'BIBLID' },
        { re: /\bcu\s*id\b/, canonical: 'CU-ID' },
        { re: /\bcrossmark\b/, canonical: 'Crossmark' },
        { re: /\bcstr\b/, canonical: 'CSTR' },
        { re: /\bjel\b/, canonical: 'JEL' },
        { re: /\boai\b/, canonical: 'OAI' },
        { re: /\bqr\b.*\bcode\b/, canonical: 'QR Code' },
        { re: /\bpid\b/, canonical: 'PID' },
        { re: /\bedu\s*nl\b/, canonical: 'Edu.nl' }
      ];

      for (const alias of aliases) {
        if (alias.re.test(normalized)) return alias.canonical;
      }

      if (/https?:\/\/|www\./.test(cleanedLower)) return 'URL';

      return smartTitle(cleaned);
    }

    function getPidSchemes(value) {
      const terms = toValueList(value).map(normalizePidSchemeTerm).filter(Boolean);
      return [...new Set(terms)];
    }

    function normalizePreservationTerm(value) {
      if (!value) return '';
      const cleaned = String(value).replace(/\s+/g, ' ').trim();
      if (!cleaned) return '';
      const normalized = normalizeForMatch(cleaned);

      const aliases = [
        { re: /\bajol\b|\bafrican journals? online\b/, canonical: 'African Journals Online' },
        { re: /\bzenodo\b|\bzenedo\b|\bzenodoo\b/, canonical: 'Zenodo' },
        { re: /\bclockss\b/, canonical: 'CLOCKSS' },
        { re: /\blockss\b/, canonical: 'LOCKSS' },
        { re: /\bpkp\b.*\bpn\b|\bpkp preservation network\b/, canonical: 'PKP Preservation Network' },
        { re: /\bportico\b/, canonical: 'Portico' },
        { re: /\bpubmed central\b|\bpmc\b/, canonical: 'PubMed Central' },
        { re: /\binternet archive\b/, canonical: 'Internet Archive' },
        { re: /\bcariniana\b/, canonical: 'Cariniana Network' },
        { re: /\bscholars?\s*portal\b/, canonical: 'Scholars Portal' },
        { re: /\bhrcak\b|\bhr cak\b|\bhr ak\b|portal of (croatian|scientific journals of croatia)/, canonical: 'Hrcak Portal of Croatian Scientific Journals' },
        { re: /\be\s*library\b|\belibrary\b|russian electronic scientific library/, canonical: 'eLIBRARY.RU' },
        { re: /\bmagiran\b/, canonical: 'Magiran' },
        { re: /\bnoormags?\b/, canonical: 'Noormags' },
        { re: /\bisc\b|\bislamic world science citation center\b/, canonical: 'Islamic World Science Citation Center' },
        { re: /\bscindeks\b|serbian citation index/, canonical: 'SCIndeks (Serbian Citation Index)' },
        { re: /\bcross\s*ref\b|\bcrossref\b/, canonical: 'CrossRef' },
        { re: /\bkoreamed synapse\b/, canonical: 'KoreaMed Synapse' },
        { re: /\bkoreamed\b/, canonical: 'KoreaMed' },
        { re: /\bceeol\b/, canonical: 'CEEOL' },
        { re: /\bcines\b/, canonical: 'CINES' },
        { re: /\braco\b/, canonical: 'RACO' },
        { re: /\bscholar\b.*\bportal\b/, canonical: 'Scholars Portal' },
        { re: /\buniversity computing centre srce\b/, canonical: 'Hrcak Portal of Croatian Scientific Journals' },
        { re: /\bgoogle scholar\b/, canonical: 'Google Scholar' },
        { re: /\bsid\b/, canonical: 'SID' },
        { re: /\bniscpr online periodicals repository\b/, canonical: 'NIScPR Online Periodicals Repository' },
        { re: /\bin[- ]?house archiving\b/, canonical: 'In-house Archiving' },
        { re: /\bjournal'?s?\s+website\b|\bjournal\s+website\b/, canonical: 'Journal Website' },
        { re: /\bnational digital archives of iranian scholarly journals\b/, canonical: 'National Digital Archives of Iranian Scholarly Journals' },
        { re: /\be\s*depot\b/, canonical: 'E-Depot' },
        { re: /\bnational library of the netherlands\b|\bkoninklijke bibliotheek\b|\bkb\b/, canonical: 'KB National Library of the Netherlands' }
      ];

      for (const alias of aliases) {
        if (alias.re.test(normalized)) return alias.canonical;
      }

      const paren = cleaned.match(/\(([^)]+)\)/);
      if (paren) {
        const inner = paren[1].replace(/\s+/g, ' ').trim();
        if (inner.length > 4 && inner.includes(' ')) return inner;
      }

      return smartTitle(cleaned);
    }

    function getPreservationTerms(value) {
      const terms = toValueList(value).map(normalizePreservationTerm).filter(Boolean);
      return [...new Set(terms)];
    }

    function normalizePeerReviewTerm(value) {
      if (!value) return '';
      const cleaned = String(value).replace(/\s+/g, ' ').trim();
      if (!cleaned) return '';
      const normalized = normalizeForMatch(cleaned);

      const aliases = [
        { re: /\bpartial\b.*\bdouble\b.*\b(anonymous|blind)\b|\bdouble\b.*\b(anonymous|blind)\b/, canonical: 'Double anonymous peer review' },
        { re: /\btriple\b.*\b(anonymous|blind)\b/, canonical: 'Triple anonymous peer review' },
        { re: /\bopen peer commentary\b|\bopen\b.*\bpeer\b.*\breview\b/, canonical: 'Open peer review' },
        { re: /\bpost publication\b.*\bpeer\b.*\breview\b/, canonical: 'Post-publication peer review' },
        { re: /\bcrowd\b.*\breview\b/, canonical: 'Crowd review' },
        { re: /\bcommittee\b.*\breview\b/, canonical: 'Committee review' },
        { re: /\b(editorial review|collaborative editorial)\b/, canonical: 'Editorial review' },
        { re: /\b(single|anonymous|blind)\b.*\bpeer\b.*\breview\b|\banonymous peer review\b/, canonical: 'Anonymous peer review' },
        { re: /\bpeer\b.*\breview\b/, canonical: 'Peer review' }
      ];

      for (const alias of aliases) {
        if (alias.re.test(normalized)) return alias.canonical;
      }
      return smartTitle(cleaned);
    }

    function getPeerReviewTerms(value) {
      const terms = toValueList(value).map(normalizePeerReviewTerm).filter(Boolean);
      return [...new Set(terms)];
    }

    function normalizeDepositPolicyTerm(value) {
      if (!value) return '';
      const cleaned = String(value).replace(/\s+/g, ' ').trim();
      if (!cleaned) return '';
      const normalized = normalizeForMatch(cleaned);

      const aliases = [
        { re: /\bopen policy finder\b|\bsherpa\s*romeo\b/, canonical: 'Open Policy Finder' },
        { re: /\bdiadorim\b/, canonical: 'Diadorim' },
        { re: /\bdulcinea\b/, canonical: 'Dulcinea' },
        { re: /\bmir\s*bel\b|\bmirabel\b/, canonical: 'Mir@bel' },
        { re: /\bmalena\b/, canonical: 'Malena' },
        { re: /\baura\b/, canonical: 'AURA' },
        { re: /\bdergipark\b/, canonical: 'DergiPark' },
        { re: /\bgaruda\b|\bgarba rujukan digital\b/, canonical: 'Garuda' },
        { re: /\bpulisher\b.*\b(site|website)\b|\bpublisher\b.*\bown\b.*\b(site|website)\b|\bpublisher\b.*\b(site|website)\b/, canonical: "Publisher's own site" },
        { re: /\bjournal\b.*\bown\b.*\b(site|website)\b|\bjournal own website\b/, canonical: "Journal's own site" },
        { re: /\bjournal\b.*\b(site|website)\b/, canonical: 'Journal website' },
        { re: /\bpreprint\b.*\bpostprint\b.*\bpolicy\b/, canonical: 'Preprint and postprint policy' },
        { re: /\bself\b.*\barchiving\b/, canonical: 'Self-archiving policy' },
        { re: /\brepository\b.*\bpolicy\b/, canonical: 'Repository policy' },
        { re: /\bin[- ]?house\b.*\brepository\b/, canonical: 'In-house repository' },
        { re: /\bcopyright\b/, canonical: 'Copyright notice' },
        { re: /\bauthors?\b.*\brights?\b/, canonical: "Authors' rights" },
        { re: /\binstitutional\b.*\brepository\b/, canonical: 'Institutional repository' },
        { re: /\bbrill\b/, canonical: 'Brill.com' },
        { re: /\bour own site\b/, canonical: "Publisher's own site" },
        { re: /\bpublic and\s+or commercial subject based repositories\b/, canonical: 'Public and/or commercial subject-based repositories' },
        { re: /\bkarger permits authors of open access articles\b/, canonical: 'Karger policy statement' },
        { re: /\bcross\s*ref\b|\bcrossref\b/, canonical: 'CrossRef' }
      ];

      for (const alias of aliases) {
        if (alias.re.test(normalized)) return alias.canonical;
      }
      if (/\bpublisher\b/.test(normalized) && /\b(site|website)\b/.test(normalized)) return "Publisher's own site";
      if (/\bjournal\b/.test(normalized) && /\b(site|website)\b/.test(normalized)) return 'Journal website';
      return smartTitle(cleaned);
    }

    function getDepositPolicyTerms(value) {
      const terms = toValueList(value).map(normalizeDepositPolicyTerm).filter(Boolean);
      return [...new Set(terms)];
    }

    function titleCase(value) {
      return String(value)
        .toLowerCase()
        .replace(/\b([a-z])/g, ch => ch.toUpperCase());
    }

    function formatCountry(country) {
      if (!country) return NOT_AVAILABLE;
      const raw = String(country).trim();
      const cleaned = raw.replace(/_/g, ' ');
      const upper = cleaned.toUpperCase();

      if (/^[A-Z]{2}$/.test(upper) && countryNameFormatter) {
        const resolved = countryNameFormatter.of(upper);
        if (resolved && resolved !== upper) return resolved;
      }

      if (/^[A-Z][A-Z\s-]{3,}$/.test(cleaned)) {
        return titleCase(cleaned);
      }

      return cleaned;
    }

    function shortLabel(text, maxLen = 45) {
      if (!text) return '—';
      const value = String(text);
      return value.length <= maxLen ? value : `${value.slice(0, maxLen - 3)}...`;
    }

    function getCreatedYear(record) {
      if (!record || !record.created_date) return null;
      const year = new Date(record.created_date).getUTCFullYear();
      return Number.isNaN(year) ? null : year;
    }

    function syncYearLabels() {
      const fromEl = document.getElementById('year-from');
      const toEl = document.getElementById('year-to');
      document.getElementById('year-from-label').textContent = fromEl.value || '—';
      document.getElementById('year-to-label').textContent = toEl.value || '—';
    }

    function setupYearRange() {
      const fromEl = document.getElementById('year-from');
      const toEl = document.getElementById('year-to');
      const years = state.records.map(getCreatedYear).filter(y => y !== null);

      if (!years.length) {
        state.yearBounds = null;
        fromEl.disabled = true;
        toEl.disabled = true;
        fromEl.value = '';
        toEl.value = '';
        syncYearLabels();
        return;
      }

      const min = Math.min(...years);
      const max = Math.max(...years);
      state.yearBounds = { min, max };

      fromEl.disabled = false;
      toEl.disabled = false;
      fromEl.min = String(min);
      fromEl.max = String(max);
      toEl.min = String(min);
      toEl.max = String(max);

      if (!fromEl.value || Number.isNaN(parseInt(fromEl.value, 10))) fromEl.value = String(min);
      if (!toEl.value || Number.isNaN(parseInt(toEl.value, 10))) toEl.value = String(max);
      if (parseInt(fromEl.value, 10) < min) fromEl.value = String(min);
      if (parseInt(fromEl.value, 10) > max) fromEl.value = String(max);
      if (parseInt(toEl.value, 10) < min) toEl.value = String(min);
      if (parseInt(toEl.value, 10) > max) toEl.value = String(max);
      if (parseInt(fromEl.value, 10) > parseInt(toEl.value, 10)) fromEl.value = toEl.value;

      syncYearLabels();
    }

    function resetYearRange() {
      const fromEl = document.getElementById('year-from');
      const toEl = document.getElementById('year-to');
      if (!state.yearBounds) {
        fromEl.value = '';
        toEl.value = '';
      } else {
        fromEl.value = String(state.yearBounds.min);
        toEl.value = String(state.yearBounds.max);
      }
      syncYearLabels();
    }

    async function loadJsonOrNull(path) {
      try {
        const res = await fetch(path, { cache: 'no-store' });
        if (!res.ok) return null;
        return await res.json();
      } catch (_err) {
        return null;
      }
    }

    async function loadData() {
      const [journalsRes, aggRes, metaRes] = await Promise.all([
        loadJsonOrNull('data/journals.json'),
        loadJsonOrNull('data/aggregates.json'),
        loadJsonOrNull('data/meta.json')
      ]);

      if (!Array.isArray(journalsRes) || journalsRes.length === 0) {
        state.records = [];
        state.filtered = [];
        state.aggregates = aggRes || {};
        state.meta = metaRes || {};
        setStatus('Data is not available yet. Trigger the \"Fetch DOAJ journals (hourly)\" GitHub Action, then refresh this page.');
        renderAll();
        return;
      }

      state.records = journalsRes;
      state.filtered = journalsRes;
      state.aggregates = aggRes || {};
      state.meta = metaRes || {};
      if (state.meta.is_capped) {
        setStatus(`Showing ${state.meta.fetched_total || journalsRes.length} of ${state.meta.source_total || journalsRes.length} journals due to source result-window limits (${state.meta.result_cap || 1000} records per query).`);
      } else {
        setStatus('');
      }
      populateFilters();
      renderAll();
    }

    function populateFilters() {
      const countries = Array.from(new Set(state.records.map(r => r.country).filter(Boolean)))
        .sort((a, b) => formatCountry(a).localeCompare(formatCountry(b)));
      const licenses = Array.from(new Set(state.records.flatMap(r => toValueList(r.license_type))))
        .sort((a, b) => String(a).localeCompare(String(b)));
      const peerReviews = Array.from(new Set(state.records.flatMap(r => getPeerReviewTerms(r.peer_review_type))))
        .sort((a, b) => String(a).localeCompare(String(b)));
      const preservations = Array.from(new Set(state.records.flatMap(r => getPreservationTerms(r.preservation_service))))
        .sort((a, b) => String(a).localeCompare(String(b)));
      const depositPolicyDirectories = Array.from(new Set(state.records.flatMap(r => getDepositPolicyTerms(r.deposit_policy_directory))))
        .sort((a, b) => String(a).localeCompare(String(b)));
      const pidSchemes = Array.from(new Set(state.records.flatMap(r => getPidSchemes(r.pid_scheme))))
        .sort((a, b) => String(a).localeCompare(String(b)));
      const languages = Array.from(new Set(state.records.flatMap(r => getSimpleTerms(r.language))))
        .sort((a, b) => String(a).localeCompare(String(b)));

      const countrySelect = document.getElementById('country');
      countrySelect.length = 1;
      countries.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = formatCountry(c);
        countrySelect.appendChild(opt);
      });
      const licenseSelect = document.getElementById('license');
      licenseSelect.length = 1;
      licenses.forEach(c => {
        const opt = document.createElement('option'); opt.value = c; opt.textContent = c; licenseSelect.appendChild(opt);
      });

      const peerReviewSelect = document.getElementById('peer-review');
      peerReviewSelect.length = 1;
      peerReviews.forEach(review => {
        const opt = document.createElement('option');
        opt.value = review;
        opt.textContent = review;
        peerReviewSelect.appendChild(opt);
      });

      const preservationSelect = document.getElementById('preservation');
      preservationSelect.length = 1;
      preservations.forEach(service => {
        const opt = document.createElement('option');
        opt.value = service;
        opt.textContent = service;
        preservationSelect.appendChild(opt);
      });

      const depositPolicySelect = document.getElementById('deposit-policy');
      depositPolicySelect.length = 1;
      depositPolicyDirectories.forEach(directory => {
        const opt = document.createElement('option');
        opt.value = directory;
        opt.textContent = directory;
        depositPolicySelect.appendChild(opt);
      });

      const pidSelect = document.getElementById('pid');
      pidSelect.length = 1;
      pidSchemes.forEach(scheme => {
        const opt = document.createElement('option');
        opt.value = scheme;
        opt.textContent = formatPidScheme(scheme);
        pidSelect.appendChild(opt);
      });

      const languageSelect = document.getElementById('language');
      languageSelect.length = 1;
      languages.forEach(language => {
        const opt = document.createElement('option');
        opt.value = language;
        opt.textContent = language;
        languageSelect.appendChild(opt);
      });

      setupYearRange();
    }

    function applyFilters() {
      const country = document.getElementById('country').value;
      const license = document.getElementById('license').value;
      const apc = document.getElementById('apc').value;
      const author = document.getElementById('author-retains').value;
      const peerReview = document.getElementById('peer-review').value;
      const preservation = document.getElementById('preservation').value;
      const depositPolicy = document.getElementById('deposit-policy').value;
      const pid = document.getElementById('pid').value;
      const language = document.getElementById('language').value;
      const publisher = document.getElementById('publisher').value.trim().toLowerCase();
      const subject = document.getElementById('subject').value.trim().toLowerCase();
      const yearFrom = parseInt(document.getElementById('year-from').value, 10);
      const yearTo = parseInt(document.getElementById('year-to').value, 10);

      state.filtered = state.records.filter(r => {
        if (country && r.country !== country) return false;
        if (license && !toValueList(r.license_type).includes(license)) return false;
        if (apc === 'yes' && r.apc_has !== true) return false;
        if (apc === 'no' && r.apc_has !== false) return false;
        if (author === 'yes' && r.author_retains !== true) return false;
        if (author === 'no' && r.author_retains !== false) return false;
        if (peerReview && !getPeerReviewTerms(r.peer_review_type).includes(peerReview)) return false;
        if (preservation && !getPreservationTerms(r.preservation_service).includes(preservation)) return false;
        if (depositPolicy && !getDepositPolicyTerms(r.deposit_policy_directory).includes(depositPolicy)) return false;
        if (pid && !getPidSchemes(r.pid_scheme).includes(pid)) return false;
        if (language && !getSimpleTerms(r.language).includes(language)) return false;
        if (publisher && !(r.publisher || '').toLowerCase().includes(publisher)) return false;
        if (subject && !(r.subject_terms || []).some(s => s.toLowerCase().includes(subject))) return false;
        if (state.yearBounds && !Number.isNaN(yearFrom) && !Number.isNaN(yearTo)) {
          const usesYearNarrowing = yearFrom > state.yearBounds.min || yearTo < state.yearBounds.max;
          if (usesYearNarrowing) {
            const y = getCreatedYear(r);
            if (y === null) return false;
            if (y < yearFrom || y > yearTo) return false;
          }
        }
        return true;
      });
      renderAll();
    }

    function resetFilters() {
      document.querySelectorAll('.filters select').forEach(el => el.value = '');
      document.querySelectorAll('.filters input[type="text"]').forEach(el => el.value = '');
      resetYearRange();
      state.filtered = state.records;
      renderAll();
    }

    function renderKPIs() {
      document.getElementById('kpi-total').textContent = formatNumber(state.filtered.length);
      document.getElementById('kpi-updated').textContent = formatDate(state.meta.source_last_updated_max || state.meta.fetched_at);
      const apcYes = state.filtered.filter(r => r.apc_has === true).length;
      document.getElementById('kpi-apc').textContent = formatNumber(apcYes);
      const presYes = state.filtered.filter(r => r.preservation_has === true).length;
      document.getElementById('kpi-pres').textContent = formatNumber(presYes);
      const pidYes = state.filtered.filter(r => r.pid_has === true).length;
      document.getElementById('kpi-pid').textContent = formatNumber(pidYes);
      const metaText = `Fetched: ${formatDate(state.meta.fetched_at)} | Source last updated: ${formatDate(state.meta.source_last_updated_max)}`;
      document.getElementById('meta-info').textContent = metaText;
    }

    function renderCharts() {
      if (!state.filtered.length) {
        renderEmptyCharts();
        return;
      }

      // Country bar (top 12)
      const countryCounts = {};
      for (const r of state.filtered) if (r.country) countryCounts[r.country] = (countryCounts[r.country] || 0) + 1;
      const topCountries = Object.entries(countryCounts).sort((a,b) => b[1]-a[1]).slice(0,12);
      const countryLabels = topCountries.map(d => formatCountry(d[0]));
      const countryValues = topCountries.map(d => d[1]);
      Plotly.newPlot(
        'chart-country',
        [{
          type:'bar',
          orientation: 'h',
          x: countryValues.slice().reverse(),
          y: countryLabels.slice().reverse(),
          marker:{color:'#3A5959'}
        }],
        {
          title:'Top countries',
          margin:{l:260,r:12,t:46,b:48},
          paper_bgcolor:'rgba(0,0,0,0)',
          plot_bgcolor:'rgba(0,0,0,0)',
          font:{color:'#282624'},
          yaxis:{automargin:true}
        },
        {displayModeBar:false}
      );

      // License mix (horizontal)
      const licCounts = {};
      for (const r of state.filtered) {
        for (const lic of toValueList(r.license_type)) {
          licCounts[lic] = (licCounts[lic] || 0) + 1;
        }
      }
      const licEntries = Object.entries(licCounts).sort((a, b) => b[1] - a[1]).slice(0, 12);
      Plotly.newPlot(
        'chart-license',
        [{
          type:'bar',
          orientation:'h',
          x: licEntries.map(d => d[1]).reverse(),
          y: licEntries.map(d => shortLabel(d[0], 52)).reverse(),
          marker:{color:'#FD5A3B'}
        }],
        {
          title:'License mix',
          margin:{l:280,r:12,t:46,b:48},
          paper_bgcolor:'rgba(0,0,0,0)',
          plot_bgcolor:'rgba(0,0,0,0)',
          font:{color:'#282624'},
          yaxis:{automargin:true}
        },
        {displayModeBar:false}
      );

      // APC yes/no (pie)
      const apcCounts = {yes:0, no:0};
      for (const r of state.filtered) {
        if (r.apc_has === true) apcCounts.yes++;
        else if (r.apc_has === false) apcCounts.no++;
      }
      Plotly.newPlot(
        'chart-apc',
        [{
          type:'pie',
          hole:0.42,
          labels:['Yes', 'No'],
          values:[apcCounts.yes, apcCounts.no],
          marker:{colors:['#FD5A3B','#47A178']}
        }],
        {title:'APC presence', paper_bgcolor:'rgba(0,0,0,0)', font:{color:'#282624'}},
        {displayModeBar:false}
      );

      // Subjects top 12
      const subjCounts = {};
      for (const r of state.filtered) for (const s of (r.subject_terms || [])) subjCounts[s] = (subjCounts[s] || 0) + 1;
      const subjTop = Object.entries(subjCounts).sort((a,b)=>b[1]-a[1]).slice(0,12);
      const subjectLabels = subjTop.map(d => shortLabel(d[0], 55));
      const subjectValues = subjTop.map(d => d[1]);
      Plotly.newPlot(
        'chart-subjects',
        [{
          type:'bar',
          orientation: 'h',
          x: subjectValues.slice().reverse(),
          y: subjectLabels.slice().reverse(),
          marker:{color:'#FA9A87'}
        }],
        {
          title:'Subjects (top 12)',
          margin:{l:320,r:12,t:46,b:48},
          paper_bgcolor:'rgba(0,0,0,0)',
          plot_bgcolor:'rgba(0,0,0,0)',
          font:{color:'#282624'},
          yaxis:{automargin:true}
        },
        {displayModeBar:false}
      );

      // Timeline by created year
      const yearCounts = {};
      for (const r of state.filtered) {
        if (r.created_date) {
          const y = new Date(r.created_date).getUTCFullYear();
          if (!Number.isNaN(y)) yearCounts[y] = (yearCounts[y] || 0) + 1;
        }
      }
      const years = Object.keys(yearCounts).map(Number).sort((a,b)=>a-b);
      Plotly.newPlot('chart-timeline', [{type:'scatter', mode:'lines+markers', x: years, y: years.map(y=>yearCounts[y]), line:{color:'#47A178'}}], {title:'Created year trend', margin:{l:40,r:10,t:40,b:40}, paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)', font:{color:'#282624'}}, {displayModeBar:false});
    }

    function renderEmptyCharts() {
      const ids = ['chart-country', 'chart-license', 'chart-apc', 'chart-subjects', 'chart-timeline'];
      const titles = ['Top countries', 'License mix', 'APC presence', 'Subjects (top 12)', 'Created year trend'];
      ids.forEach((id, i) => {
        Plotly.newPlot(
          id,
          [],
          {
            title: titles[i],
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: '#282624' },
            xaxis: { visible: false },
            yaxis: { visible: false },
            annotations: [{
              text: 'No data yet',
              showarrow: false,
              xref: 'paper',
              yref: 'paper',
              x: 0.5,
              y: 0.5,
              font: { color: '#282624', size: 14 }
            }]
          },
          { displayModeBar: false }
        );
      });
    }

    function renderTable() {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';
      const rows = state.filtered.slice(0, 50);
      document.getElementById('table-count').textContent = `${rows.length} shown of ${state.filtered.length} filtered`;
      if (!rows.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="8" class="muted">No journal data available yet.</td>';
        tbody.appendChild(tr);
        return;
      }
      for (const r of rows) {
        const licenseText = toValueList(r.license_type).join(', ') || NOT_AVAILABLE;
        const preservationText = getPreservationTerms(r.preservation_service).join(', ') || NOT_AVAILABLE;
        const pidText = getPidSchemes(r.pid_scheme).map(formatPidScheme).join(', ') || NOT_AVAILABLE;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.title || NOT_AVAILABLE}</td>
          <td>${r.publisher || NOT_AVAILABLE}</td>
          <td>${formatCountry(r.country)}</td>
          <td>${licenseText}</td>
          <td>${r.apc_has === true ? '<span class="pill">Yes</span>' : r.apc_has === false ? '<span class="pill negative">No</span>' : NOT_AVAILABLE}</td>
          <td>${preservationText}</td>
          <td>${pidText}</td>
          <td>${r.created_date ? formatDate(r.created_date) : NOT_AVAILABLE}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function renderAll() {
      renderKPIs();
      renderCharts();
      renderTable();
    }

    function wireEvents() {
      document.querySelectorAll('.filters select, .filters input[type="text"]').forEach(el => {
        el.addEventListener('change', applyFilters);
        el.addEventListener('keyup', ev => { if (ev.key === 'Enter') applyFilters(); });
      });
      const fromEl = document.getElementById('year-from');
      const toEl = document.getElementById('year-to');
      fromEl.addEventListener('input', () => {
        if (parseInt(fromEl.value, 10) > parseInt(toEl.value, 10)) {
          toEl.value = fromEl.value;
        }
        syncYearLabels();
        applyFilters();
      });
      toEl.addEventListener('input', () => {
        if (parseInt(toEl.value, 10) < parseInt(fromEl.value, 10)) {
          fromEl.value = toEl.value;
        }
        syncYearLabels();
        applyFilters();
      });
      document.getElementById('reset').addEventListener('click', resetFilters);
    }

    async function init() {
      try {
        wireEvents();
        await loadData();
      } catch (err) {
        console.error(err);
        state.records = [];
        state.filtered = [];
        state.meta = {};
        setStatus('Unable to load dashboard data. Check GitHub Actions logs and refresh.');
        renderAll();
      }
    }

    init();
  </script>
</body>
</html>
