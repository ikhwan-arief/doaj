<!doctype html>
<!--
  Copyright (c) 2026 Ikhwan Arief, Universitas Andalas.
  Code license: PolyForm Noncommercial 1.0.0
  https://polyformproject.org/licenses/noncommercial/1.0.0/
  Content/license text in this dashboard UI: CC BY-NC-SA 4.0
  https://creativecommons.org/licenses/by-nc-sa/4.0/
  See LICENSE, LICENSE-CODE.md, and LICENSE-CONTENT.md.
-->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Open Access Journals in DOAJ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700&family=Source+Sans+Pro:wght@400;600;700&family=Source+Code+Pro:wght@500&display=swap" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root {
      --bg: #F6F4F4;           /* light-grey */
      --card: #FFFFFF;         /* white */
      --muted: #5C5956;        /* dark-grey */
      --text: #282624;         /* warm-black */
      --accent: #FD5A3B;       /* grapefruit */
      --accent-2: #FA9A87;     /* salmon */
      --accent-3: #47A178;     /* mid-green */
      --border: #D7D2CE;       /* light border */
      --shadow: 0 10px 24px rgba(40, 38, 36, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Source Sans Pro', system-ui, -apple-system, sans-serif;
      background:
        radial-gradient(circle at 20% 20%, rgba(253,90,59,0.08), transparent 35%),
        radial-gradient(circle at 80% 0%, rgba(163,195,134,0.12), transparent 35%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      padding: 24px 28px 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: baseline;
    }
    h1 { margin: 0; font-size: 26px; letter-spacing: -0.4px; font-family: 'Spectral', 'Source Sans Pro', serif; }
    .muted { color: var(--muted); font-size: 14px; }
    .subline a { color: #982E0A; text-decoration: none; font-weight: 700; }
    .subline a:hover { text-decoration: underline; }
    .layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
      padding: 0 28px 40px;
    }
    @media (max-width: 960px) {
      .layout { grid-template-columns: 1fr; }
    }
    .icon-chip {
      width: 26px;
      height: 26px;
      border-radius: 10px;
      background: rgba(40, 38, 36, 0.06);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 26px;
    }
    .icon-chip.accent { background: rgba(253, 90, 59, 0.16); }
    .icon-chip.success { background: rgba(71, 161, 120, 0.16); }
    .icon-chip.muted { background: rgba(92, 89, 86, 0.12); }
    .icon-chip svg {
      width: 14px;
      height: 14px;
      stroke: var(--text);
      stroke-width: 1.7;
      fill: none;
    }
    .panel, .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
    }
    .panel { padding: 18px; }
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin: 0 28px 18px;
    }
    .card {
      padding: 14px 16px;
    }
    .card .label {
      color: var(--muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .card .value { font-size: 24px; font-weight: 700; margin-top: 6px; }
    .filters h3 { margin: 0 0 12px; }
    .filter-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }
    label { font-weight: 600; font-size: 14px; }
    select, input, button {
      width: 100%;
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #FFFFFF;
      color: var(--text);
      font-size: 14px;
    }
    input::placeholder { color: #8C8681; }
    button {
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border: none;
      font-weight: 700;
      letter-spacing: 0.02em;
    }
    .subject-empty { color: var(--muted); font-size: 13px; }
    .country-subject { margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 6px; }
    .country-subject-title { font-weight: 700; font-size: 13px; color: var(--muted); letter-spacing: 0.02em; }
    .country-subject-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 8px; }
    .country-subject-item { display: flex; justify-content: space-between; align-items: center; background: rgba(40, 38, 36, 0.03); border-radius: 10px; padding: 6px 9px; font-weight: 600; }
    .country-subject-name { color: var(--text); }
    .country-subject-pill { padding: 3px 8px; border-radius: 999px; background: rgba(253, 90, 59, 0.14); color: #982E0A; font-size: 12px; font-weight: 700; }
    .overlap-box { margin: 18px 28px 30px; }
    .overlap-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; }
    .overlap-card { background: rgba(40, 38, 36, 0.03); border-radius: 10px; padding: 10px 12px; border: 1px solid var(--border); }
    .overlap-card h4 { margin: 0 0 6px; font-size: 14px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; }
    .overlap-metric { font-size: 22px; font-weight: 800; }
    .overlap-list { margin: 0; padding-left: 16px; font-size: 13px; }
    .overlap-list li { margin-bottom: 2px; }
    .charts { display: grid; gap: 14px; padding: 0 28px; }
    .chart-row { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 14px; }
    .chart-row.single { grid-template-columns: 1fr; }
    @media (max-width: 1200px) {
      .chart-row { grid-template-columns: 1fr; }
    }
    .chart-box {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
      box-shadow: var(--shadow);
      min-height: 320px;
      position: relative;
    }
    .box-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      padding: 4px 4px 8px;
    }
    .chart-content { min-height: 260px; }
    .chart-box .gtitle { display: none !important; }
    .chart-box .svg-container { padding-top: 0 !important; }
    .apc-country-box { display: flex; flex-direction: column; }
    .apc-country-control {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      margin: 2px 6px 8px;
      flex-wrap: wrap;
    }
    .apc-country-control-group { display: flex; align-items: center; gap: 6px; }
    .apc-country-control label {
      font-size: 12px;
      font-weight: 700;
      color: var(--muted);
      white-space: nowrap;
    }
    .apc-country-control select {
      width: auto;
      min-width: 180px;
      padding: 6px 8px;
      font-size: 12px;
      border-radius: 8px;
    }
    #chart-apc-distribution { width: 100%; }
    .chart-box.map-box { min-height: 500px; }
    .map-shell { position: relative; }
    .map-plot { min-height: 460px; width: 100%; }
    #chart-country-map-shell:fullscreen {
      width: 100vw;
      height: 100vh;
      background: var(--bg);
    }
    #chart-country-map-shell:-webkit-full-screen {
      width: 100vw;
      height: 100vh;
      background: var(--bg);
    }
    #chart-country-map-shell:fullscreen .map-plot {
      height: 100%;
    }
    #chart-country-map-shell:-webkit-full-screen .map-plot {
      height: 100%;
    }
    .map-fullscreen-btn {
      position: absolute;
      right: 12px;
      top: 10px;
      z-index: 12;
      width: auto;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #FFFFFF;
      color: var(--text);
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0;
      box-shadow: 0 6px 14px rgba(40, 38, 36, 0.1);
    }
    .map-fullscreen-btn:hover { background: #F6F4F4; }
    .map-continent-legend {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 12;
      max-width: 240px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.94);
      box-shadow: 0 6px 14px rgba(40, 38, 36, 0.08);
      font-size: 12px;
      color: var(--text);
    }
    .map-continent-legend .legend-title {
      font-weight: 700;
      margin-bottom: 6px;
      font-size: 11px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .map-continent-legend .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
      white-space: nowrap;
    }
    .map-continent-legend .legend-item:last-child { margin-bottom: 0; }
    .map-continent-legend .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(40, 38, 36, 0.24);
      flex: 0 0 10px;
    }
    .map-fullscreen-footer {
      display: none;
      position: absolute;
      right: 12px;
      bottom: 10px;
      z-index: 12;
      padding: 4px 8px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 10px;
      font-weight: 500;
      text-align: right;
      pointer-events: none;
    }
    #chart-country-map-shell:fullscreen .map-fullscreen-footer,
    #chart-country-map-shell:-webkit-full-screen .map-fullscreen-footer {
      display: block;
    }
    .table-box {
      margin: 18px 28px 40px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 14px;
      overflow-x: auto;
    }
    table { width: 100%; min-width: 940px; border-collapse: collapse; font-family: 'Source Sans Pro', system-ui, -apple-system, sans-serif; }
    th, td { text-align: left; padding: 8px 6px; border-bottom: 1px solid var(--border); vertical-align: top; }
    th { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.06em; }
    .pill { display: inline-block; padding: 3px 8px; border-radius: 999px; font-size: 12px; background: rgba(71,161,120,0.18); color: #2F6E52; }
    .pill.negative { background: rgba(253,90,59,0.18); color: #8F311C; }
    .pill.warn { background: rgba(152,46,10,0.18); color: #982E0A; margin-left: 6px; }
    .table-link { color: #982E0A; text-decoration: none; font-weight: 600; }
    .table-link:hover { text-decoration: underline; }
    .country-text { font-weight: 700; }
    .table-toolbar { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 8px; flex-wrap: wrap; }
    .table-controls { margin: 8px 0 10px; display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
    .table-search { margin: 0; max-width: 520px; flex: 1 1 320px; }
    .table-search label { display: block; margin-bottom: 4px; }
    .table-inline-filters { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; }
    .table-filter-group { min-width: 185px; }
    .table-filter-group label { display: block; margin-bottom: 4px; }
    .table-filter-group select { width: 100%; }
    .table-nav { display: flex; align-items: center; gap: 8px; }
    .table-nav button {
      width: auto;
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 8px;
      background: #3A5959;
      color: #FFFFFF;
      letter-spacing: 0;
      font-weight: 600;
    }
    .table-nav button:disabled { opacity: 0.5; cursor: not-allowed; }
    .table-page { font-size: 13px; color: var(--muted); min-width: 108px; text-align: center; }
    .table-footer {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; background: #22c55e; }
    .status-banner {
      margin: 0 28px 14px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(253, 90, 59, 0.12);
      color: #7A2A18;
      font-size: 14px;
    }
    .status-banner.hidden { display: none; }
    .year-range-wrap { display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; }
    .year-end { font-size: 13px; color: var(--muted); min-width: 42px; text-align: center; font-weight: 700; }
    .year-range-dual { position: relative; width: 100%; height: 24px; }
    .year-range-dual input[type="range"] {
      position: absolute;
      inset: 0;
      width: 100%;
      margin: 0;
      pointer-events: none;
      background: transparent;
    }
    .year-range-dual input[type="range"]::-webkit-slider-thumb { pointer-events: auto; }
    .year-range-dual input[type="range"]::-moz-range-thumb { pointer-events: auto; }
    #year-from { z-index: 3; }
    #year-to { z-index: 4; }
    input[type="range"] {
      width: 100%;
      padding: 0;
      height: 24px;
      background: transparent;
      border: 0;
      accent-color: var(--accent);
      cursor: pointer;
    }
    .site-footer {
      color: var(--muted);
      font-size: 12px;
      padding: 20px 28px 30px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .site-footer a { color: #982E0A; text-decoration: none; font-weight: 600; }
    .site-footer a:hover { text-decoration: underline; }
    .footer-row { display: flex; justify-content: space-between; gap: 12px; align-items: center; }
    .footer-source { justify-content: flex-start; }
    @media (max-width: 1024px) {
      header { padding: 20px 20px 12px; }
      .card-grid { margin: 0 20px 16px; }
      .layout { padding: 0 20px 30px; }
      .charts { padding: 0 20px; }
      .table-box { margin: 18px 20px 30px; }
    }
    @media (max-width: 768px) {
      h1 { font-size: 22px; }
      .muted { font-size: 13px; }
      .panel { padding: 14px; }
      .card-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
      .card { padding: 12px 12px; }
      .card .value { font-size: 20px; }
      .chart-box { min-height: 260px; padding: 8px; }
      .chart-box.map-box { min-height: 360px; }
      .map-plot { min-height: 320px; }
      .map-continent-legend { max-width: 220px; font-size: 11px; }
      .apc-country-control { justify-content: flex-start; margin: 0 2px 6px; }
      .apc-country-control select { min-width: 0; width: 100%; }
      .table-box { padding: 10px; }
      .table-toolbar { align-items: flex-start; }
      .table-controls { align-items: stretch; }
      .table-search { max-width: none; flex-basis: 100%; }
      .table-inline-filters { width: 100%; }
      .table-filter-group { flex: 1 1 160px; min-width: 150px; }
      .table-nav { width: 100%; justify-content: space-between; }
      .table-page { min-width: 0; }
      .table-footer { align-items: flex-start; }
      .site-footer { padding: 16px 20px 24px; font-size: 11.5px; }
      .footer-row { flex-direction: column; align-items: flex-start; gap: 6px; }
      select, input, button { font-size: 15px; }
    }
    @media (max-width: 480px) {
      header { padding: 16px 14px 10px; }
      .card-grid { margin: 0 14px 14px; grid-template-columns: 1fr; }
      .layout { padding: 0 14px 24px; }
      .charts { padding: 0 14px; gap: 10px; }
      .chart-row { gap: 10px; }
      .table-box { margin: 14px 14px 24px; }
      .chart-box { min-height: 240px; }
      .chart-box.map-box { min-height: 320px; }
      .map-plot { min-height: 280px; }
      .map-continent-legend { max-width: 180px; padding: 6px 8px; font-size: 10px; }
      .table-filter-group { min-width: 0; flex-basis: 100%; }
      .site-footer { padding: 14px 14px 20px; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Open Access Journals in DOAJ</h1>
      <div class="muted subline">Live snapshot (hourly) from DOAJ public data dump - <a href="https://creativecommons.org/publicdomain/zero/1.0/" target="_blank" rel="noopener noreferrer">CC0</a></div>
    </div>
    <div style="flex:1"></div>
    <div class="muted" id="meta-info">Loading…</div>
  </header>
  <div id="status-banner" class="status-banner hidden"></div>

  <div class="card-grid" id="kpi-cards">
    <div class="card"><div class="label"><span class="icon-chip"><svg viewBox="0 0 24 24"><path d="M6 5h10a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1zM6 9h11M6 14h11"/></svg></span>Journals</div><div class="value" id="kpi-journals">–</div></div>
    <div class="card"><div class="label"><span class="icon-chip accent"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="8"/><path d="M3 12h18M12 3a15 15 0 0 0 0 18M12 3a15 15 0 0 1 0 18"/></svg></span>Country</div><div class="value" id="kpi-countries">–</div></div>
    <div class="card"><div class="label"><span class="icon-chip success"><svg viewBox="0 0 24 24"><path d="M6 4h9l3 3v13H6z"/><path d="M9 11h6M9 15h6M9 7h3"/></svg></span>Articles</div><div class="value" id="kpi-articles">–</div></div>
    <div class="card"><div class="label"><span class="icon-chip"><svg viewBox="0 0 24 24"><path d="M5 8h14M5 12h10M5 16h6"/><path d="M15 5.5 17 7M13 18l2 1.5"/></svg></span>Languages</div><div class="value" id="kpi-languages">–</div></div>
    <div class="card"><div class="label"><span class="icon-chip muted"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="7"/><path d="M8 12h5m2 0 2-2"/><path d="M5 5l14 14"/></svg></span>No APC</div><div class="value" id="kpi-no-apc">–</div></div>
  </div>

  <div class="layout">
    <div class="panel filters">
      <h3>Filters</h3>
      <div class="filter-group">
        <label for="country">Country</label>
        <select id="country"><option value="">All</option></select>
      </div>
      <div class="filter-group">
        <label for="subject-filter">Subjects</label>
        <select id="subject-filter"><option value="">All</option></select>
      </div>
      <div class="filter-group">
        <label for="license">License Type</label>
        <select id="license"><option value="">All</option></select>
      </div>
      <div class="filter-group">
        <label for="apc">APC</label>
        <select id="apc">
          <option value="">All</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="author-retains">Author Retains Copyright</label>
        <select id="author-retains">
          <option value="">All</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="peer-review">Peer Review Type</label>
        <select id="peer-review">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="language">Languages</label>
        <select id="language">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="publisher">Publisher (text)</label>
        <input id="publisher" type="text" placeholder="contains…" />
      </div>
      <div class="filter-group">
        <label for="country-sort">Country Sort (table)</label>
        <select id="country-sort">
          <option value="">Default</option>
          <option value="asc">Ascending (A-Z)</option>
          <option value="desc">Descending (Z-A)</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="year-from">Created Year</label>
        <div class="year-range-wrap">
          <span class="year-end" id="year-min-label">1900</span>
          <div class="year-range-dual">
            <input id="year-from" type="range" min="1900" max="2100" value="1900" />
            <input id="year-to" type="range" min="1900" max="2100" value="2100" />
          </div>
          <span class="year-end" id="year-max-label">2100</span>
        </div>
      </div>
      <button id="reset">Reset Filters</button>

      <div class="country-subject" id="country-subject">
        <div class="country-subject-title">Top subjects by country (top 20)</div>
        <div class="country-subject-list" id="country-subject-list"></div>
      </div>
    </div>

    <div class="charts">
      <div class="chart-row">
        <div class="chart-box">
          <div class="box-header"><span class="icon-chip success"><svg viewBox="0 0 24 24"><ellipse cx="12" cy="7" rx="6" ry="3"/><path d="M6 7v6c0 1.7 12 1.7 12 0V7M6 13c0 1.7 12 1.7 12 0"/></svg></span>Article Processing Charges</div>
          <div class="chart-content" id="chart-apc-overview"></div>
        </div>
        <div class="chart-box">
          <div class="box-header"><span class="icon-chip accent"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="7"/><path d="M14 14a3 3 0 1 1 0-4"/></svg></span>Authors retain copyright</div>
          <div class="chart-content" id="chart-author-retains"></div>
        </div>
      </div>
      <div class="chart-row">
        <div class="chart-box">
          <div class="box-header"><span class="icon-chip"><svg viewBox="0 0 24 24"><path d="M5 19h14M7 16v-6M12 19V8M17 19v-9"/></svg></span>Top 10 countries</div>
          <div class="chart-content" id="chart-country"></div>
        </div>
        <div class="chart-box">
          <div class="box-header"><span class="icon-chip"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="8"/><path d="M3 12h18M12 3a14 14 0 0 0 0 18M12 3a14 14 0 0 1 0 18"/></svg></span>Journals in each continent</div>
          <div class="chart-content" id="chart-continent"></div>
        </div>
      </div>
      <div class="chart-row">
        <div class="chart-box">
          <div class="box-header"><span class="icon-chip"><svg viewBox="0 0 24 24"><path d="M5 5h14v9H8l-3 3z"/></svg></span>Top 10 languages</div>
          <div class="chart-content" id="chart-languages"></div>
        </div>
        <div class="chart-box">
          <div class="box-header"><span class="icon-chip"><svg viewBox="0 0 24 24"><path d="M7 4h10v14l-5-3-5 3z"/></svg></span>Top 10 subjects</div>
          <div class="chart-content" id="chart-subjects"></div>
        </div>
      </div>
      <div class="chart-row">
        <div class="chart-box">
          <div class="box-header"><span class="icon-chip"><svg viewBox="0 0 24 24"><circle cx="12" cy="10" r="4"/><path d="M9 14 7 20l5-2 5 2-2-6"/></svg></span>License usage</div>
          <div class="chart-content" id="chart-license"></div>
        </div>
        <div class="chart-box">
          <div class="box-header"><span class="icon-chip"><svg viewBox="0 0 24 24"><path d="M12 4l7 3v4c0 4-3 7-7 9-4-2-7-5-7-9V7z"/><path d="M9 11l2 2 4-4"/></svg></span>Top 5 peer-review type</div>
          <div class="chart-content" id="chart-peer-review"></div>
        </div>
      </div>
      <div class="chart-row">
        <div class="chart-box">
          <div class="box-header"><span class="icon-chip"><svg viewBox="0 0 24 24"><path d="M10 14 7.5 16.5a3.5 3.5 0 0 0 5 5l2.5-2.5"/><path d="M14 10l2.5-2.5a3.5 3.5 0 0 0-5-5L9 5"/></svg></span>Top 5 Persistent Identifiers</div>
          <div class="chart-content" id="chart-pid"></div>
        </div>
        <div class="chart-box">
          <div class="box-header"><span class="icon-chip"><svg viewBox="0 0 24 24"><path d="M4 7h16v3H4z"/><path d="M6 10v7h12v-7"/><path d="M10 13h4"/></svg></span>Top 5 Preservation Services</div>
          <div class="chart-content" id="chart-preservation"></div>
        </div>
      </div>
      <div class="chart-row">
        <div class="chart-box">
          <div class="box-header"><span class="icon-chip"><svg viewBox="0 0 24 24"><path d="M6 20h12V6H6z"/><path d="M9 10h2v2H9zM13 10h2v2h-2zM9 14h2v2H9zM13 14h2v2h-2z"/></svg></span>Top 10 publishers</div>
          <div class="chart-content" id="chart-publishers"></div>
        </div>
        <div class="chart-box">
          <div class="box-header"><span class="icon-chip"><svg viewBox="0 0 24 24"><path d="M5 17h14"/><path d="M7 14l3-4 3 3 4-6"/></svg></span>Timeline of journals added to DOAJ (monthly)</div>
          <div class="chart-content" id="chart-timeline"></div>
        </div>
      </div>
      <div class="chart-row single">
        <div class="chart-box apc-country-box">
          <div class="box-header"><span class="icon-chip accent"><svg viewBox="0 0 24 24"><path d="M5 19h14"/><path d="M8 16v-5M12 19V8M16 19v-7"/><path d="M11 5h4M13 3v4"/></svg></span>Top 20 countries by APC amount</div>
          <div class="apc-country-control">
            <div class="apc-country-control-group">
              <label for="apc-country-continent">Continent</label>
            <select id="apc-country-continent">
              <option value="">All continents</option>
              <option value="Africa">Africa</option>
              <option value="Asia">Asia</option>
              <option value="Europe">Europe</option>
              <option value="North America">North America</option>
              <option value="South America">South America</option>
              <option value="Oceania">Oceania</option>
            </select>
          </div>
          <div class="apc-country-control-group">
            <label for="apc-currency">Currency</label>
            <select id="apc-currency">
              <option value="EUR">EUR</option>
              <option value="USD">USD</option>
            </select>
          </div>
        </div>
        <div class="chart-content" id="chart-apc-distribution"></div>
      </div>
      </div>
      <div class="chart-row single">
        <div class="chart-box map-box map-shell" id="chart-country-map-shell">
        <div class="box-header"><span class="icon-chip"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="8"/><path d="M3 12h18M12 3a14 14 0 0 0 0 18M12 3a14 14 0 0 1 0 18"/><path d="M14.5 13.5 17 16"/></svg></span>Country of Publishers</div>
          <button id="map-fullscreen-btn" class="map-fullscreen-btn" type="button">Full page map</button>
          <div id="map-continent-legend" class="map-continent-legend"></div>
          <div id="chart-country-map" class="map-plot"></div>
          <div class="map-fullscreen-footer">&copy; Ikhwan Arief, Universitas Andalas - CC BY-NC-SA - Data source DOAJ</div>
        </div>
      </div>
    </div>
  </div>

  <div class="table-box">
    <div class="table-toolbar">
      <h3 style="margin:0;">Journals</h3>
    </div>
    <div class="table-controls">
      <div class="table-search">
        <label for="search-query">Search (title, country, subject)</label>
        <input id="search-query" type="text" placeholder="Start typing..." autocomplete="off" />
      </div>
      <div class="table-inline-filters">
        <div class="table-filter-group">
          <label for="table-apc">APC</label>
          <select id="table-apc">
            <option value="">All</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>
        <div class="table-filter-group">
          <label for="table-author-retains">Authors holding copyright</label>
          <select id="table-author-retains">
            <option value="">All</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Journal title</th>
          <th>Country of publisher</th>
          <th>Subject</th>
          <th>APC</th>
          <th id="th-apc-max">APC (max EUR)</th>
          <th>Article records</th>
          <th>Date of inclusion</th>
          <th>Last updated</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
    <div class="table-footer">
      <div class="muted" id="table-count">–</div>
      <div class="table-nav">
        <button id="table-prev" type="button">Prev</button>
        <span class="table-page" id="table-page">Page 1 of 1</span>
        <button id="table-next" type="button">Next</button>
      </div>
    </div>
  </div>

  <div class="table-box overlap-box" id="overlap-box">
    <h3 style="margin:0 0 10px;">DOAJ–SJR overlap</h3>
    <div id="overlap-status" class="muted" style="margin-bottom:8px;"></div>
    <div class="overlap-grid">
      <div class="overlap-card">
        <h4>Overlap count</h4>
        <div class="overlap-metric" id="ov-count">–</div>
      </div>
      <div class="overlap-card">
        <h4>SJR best quartile</h4>
        <ul class="overlap-list" id="ov-quartiles"></ul>
      </div>
      <div class="overlap-card">
        <h4>Avg citations / doc by quartile</h4>
        <ul class="overlap-list" id="ov-cites"></ul>
      </div>
      <div class="overlap-card">
        <h4>H-index (p10/median/p90)</h4>
        <div class="overlap-metric" id="ov-hindex">–</div>
      </div>
      <div class="overlap-card">
        <h4>SJR score (min/median/p90)</h4>
        <div class="overlap-metric" id="ov-sjr">–</div>
      </div>
      <div class="overlap-card">
        <h4>Top countries</h4>
        <ul class="overlap-list" id="ov-countries"></ul>
      </div>
      <div class="overlap-card">
        <h4>Top SJR areas</h4>
        <ul class="overlap-list" id="ov-areas"></ul>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="footer-row">
      <div>&copy; Ikhwan Arief, Universitas Andalas. <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">CC BY-NC-SA</a>. Data source: <a href="https://doaj.org/docs/public-data-dump/" target="_blank" rel="noopener noreferrer">DOAJ</a></div>
    </div>
    <div class="footer-row footer-source" id="fx-source-note">
      <div>Exchange-rate sources: <a href="https://www.frankfurter.app/" target="_blank" rel="noopener noreferrer">Frankfurter API</a> (primary), <a href="https://open.er-api.com/" target="_blank" rel="noopener noreferrer">open.er-api.com</a> (fallback)</div>
    </div>
  </footer>

  <script>
    const state = {
      records: [],
      filtered: [],
      aggregates: {},
      meta: {},
      chartScale: {},
      fxRates: null,
      fxDate: null,
      fxSource: null,
      yearBounds: null,
      tablePage: 1,
      tablePageSize: 50,
      searchTerms: [],
      sjr: [],
      overlap: [],
      overlapStats: null
    };
    const NOT_AVAILABLE = 'Not available';
    const FX_ENDPOINTS = [
      'https://api.frankfurter.app/latest?from=EUR',
      'https://open.er-api.com/v6/latest/EUR'
    ];
    const countryNameFormatter = (typeof Intl !== 'undefined' && typeof Intl.DisplayNames !== 'undefined')
      ? new Intl.DisplayNames([navigator.language || 'en', 'en'], { type: 'region' })
      : null;
    const CONTINENT_COLORS = {
      'Africa': '#47A178',
      'Asia': '#FD5A3B',
      'Europe': '#3A5959',
      'North America': '#A3C386',
      'South America': '#F9D950',
      'Oceania': '#982E0A',
      'Other': '#5C5956'
    };
    const COUNTRY_TO_CONTINENT = {
      'Afghanistan': 'Asia',
      'Albania': 'Europe',
      'Algeria': 'Africa',
      'Angola': 'Africa',
      'Argentina': 'South America',
      'Armenia': 'Asia',
      'Australia': 'Oceania',
      'Austria': 'Europe',
      'Azerbaijan': 'Asia',
      'Bahrain': 'Asia',
      'Bangladesh': 'Asia',
      'Barbados': 'North America',
      'Belarus': 'Europe',
      'Belgium': 'Europe',
      'Bhutan': 'Asia',
      'Bolivia, Plurinational State of': 'South America',
      'Bosnia and Herzegovina': 'Europe',
      'Brazil': 'South America',
      'Brunei Darussalam': 'Asia',
      'Bulgaria': 'Europe',
      'Burkina Faso': 'Africa',
      'Cameroon': 'Africa',
      'Canada': 'North America',
      'Chile': 'South America',
      'China': 'Asia',
      'Colombia': 'South America',
      'Congo, The Democratic Republic of the': 'Africa',
      'Costa Rica': 'North America',
      'Croatia': 'Europe',
      'Cuba': 'North America',
      'Cyprus': 'Asia',
      'Czechia': 'Europe',
      "Côte d'Ivoire": 'Africa',
      'Denmark': 'Europe',
      'Dominican Republic': 'North America',
      'Ecuador': 'South America',
      'Egypt': 'Africa',
      'El Salvador': 'North America',
      'Estonia': 'Europe',
      'Ethiopia': 'Africa',
      'Finland': 'Europe',
      'France': 'Europe',
      'Gabon': 'Africa',
      'Gambia': 'Africa',
      'Georgia': 'Asia',
      'Germany': 'Europe',
      'Ghana': 'Africa',
      'Greece': 'Europe',
      'Guam': 'Oceania',
      'Guatemala': 'North America',
      'Honduras': 'North America',
      'Hong Kong': 'Asia',
      'Hungary': 'Europe',
      'Iceland': 'Europe',
      'India': 'Asia',
      'Indonesia': 'Asia',
      'Iran, Islamic Republic of': 'Asia',
      'Iraq': 'Asia',
      'Ireland': 'Europe',
      'Israel': 'Asia',
      'Italy': 'Europe',
      'Japan': 'Asia',
      'Jordan': 'Asia',
      'Kazakhstan': 'Asia',
      'Kenya': 'Africa',
      'Korea, Republic of': 'Asia',
      'Kosovo': 'Europe',
      'Kuwait': 'Asia',
      'Kyrgyzstan': 'Asia',
      'Latvia': 'Europe',
      'Lebanon': 'Asia',
      'Libya': 'Africa',
      'Lithuania': 'Europe',
      'Luxembourg': 'Europe',
      'Malawi': 'Africa',
      'Malaysia': 'Asia',
      'Mali': 'Africa',
      'Malta': 'Europe',
      'Mauritius': 'Africa',
      'Mexico': 'North America',
      'Moldova, Republic of': 'Europe',
      'Mongolia': 'Asia',
      'Montenegro': 'Europe',
      'Morocco': 'Africa',
      'Nepal': 'Asia',
      'Netherlands': 'Europe',
      'New Zealand': 'Oceania',
      'Nicaragua': 'North America',
      'Niger': 'Africa',
      'Nigeria': 'Africa',
      'North Macedonia': 'Europe',
      'Norway': 'Europe',
      'Oman': 'Asia',
      'Pakistan': 'Asia',
      'Palestine, State of': 'Asia',
      'Panama': 'North America',
      'Paraguay': 'South America',
      'Peru': 'South America',
      'Philippines': 'Asia',
      'Poland': 'Europe',
      'Portugal': 'Europe',
      'Puerto Rico': 'North America',
      'Qatar': 'Asia',
      'Romania': 'Europe',
      'Russian Federation': 'Europe',
      'Rwanda': 'Africa',
      'Saudi Arabia': 'Asia',
      'Senegal': 'Africa',
      'Serbia': 'Europe',
      'Singapore': 'Asia',
      'Slovakia': 'Europe',
      'Slovenia': 'Europe',
      'South Africa': 'Africa',
      'South Sudan': 'Africa',
      'Spain': 'Europe',
      'Sri Lanka': 'Asia',
      'Sweden': 'Europe',
      'Switzerland': 'Europe',
      'Syrian Arab Republic': 'Asia',
      'Taiwan, Province of China': 'Asia',
      'Tajikistan': 'Asia',
      'Tanzania, United Republic of': 'Africa',
      'Thailand': 'Asia',
      'Timor-Leste': 'Asia',
      'Togo': 'Africa',
      'Trinidad and Tobago': 'North America',
      'Tunisia': 'Africa',
      'Türkiye': 'Asia',
      'Uganda': 'Africa',
      'Ukraine': 'Europe',
      'United Arab Emirates': 'Asia',
      'United Kingdom': 'Europe',
      'United States': 'North America',
      'Uruguay': 'South America',
      'Uzbekistan': 'Asia',
      'Venezuela, Bolivarian Republic of': 'South America',
      'Viet Nam': 'Asia',
      'Yemen': 'Asia',
      'Zimbabwe': 'Africa',
      'Åland Islands': 'Europe'
    };

    function setStatus(message) {
      const el = document.getElementById('status-banner');
      if (!message) {
        el.textContent = '';
        el.classList.add('hidden');
        return;
      }
      el.textContent = message;
      el.classList.remove('hidden');
    }

    function formatNumber(n) {
      return n === undefined || n === null ? "–" : n.toLocaleString();
    }

    function formatDate(iso) {
      if (!iso) return "–";
      const d = new Date(iso);
      return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function toValueList(value) {
      if (value === null || value === undefined) return [];
      if (Array.isArray(value)) return value.flatMap(toValueList).filter(Boolean);
      if (typeof value === 'object') {
        for (const key of ['scheme', 'service', 'name', 'term', 'type', 'id']) {
          if (typeof value[key] === 'string' && value[key].trim()) return [value[key].trim()];
        }
        return [];
      }
      const text = String(value).trim();
      if (!text) return [];
      const parts = text.split(/[|;,\n]+/).map(part => part.trim()).filter(Boolean);
      return [...new Set(parts)];
    }

    function normalizeSimpleTerm(value) {
      if (!value) return '';
      const cleaned = String(value).replace(/\s+/g, ' ').trim();
      if (!cleaned) return '';
      if (cleaned === cleaned.toLowerCase() || cleaned === cleaned.toUpperCase()) {
        return titleCase(cleaned);
      }
      return cleaned;
    }

    function getSimpleTerms(value) {
      const terms = toValueList(value).map(normalizeSimpleTerm).filter(Boolean);
      return [...new Set(terms)];
    }

    function normalizeForMatch(value) {
      const folded = String(value).normalize('NFKD').replace(/[\u0300-\u036f]/g, '');
      return folded.toLowerCase().replace(/[^a-z0-9\s]/g, ' ').replace(/\s+/g, ' ').trim();
    }

    function smartTitle(value) {
      const cleaned = String(value);
      if (cleaned === cleaned.toLowerCase() || cleaned === cleaned.toUpperCase()) {
        return titleCase(cleaned);
      }
      return cleaned;
    }

    function formatPidScheme(value) {
      const canonical = normalizePidSchemeTerm(value);
      return canonical || NOT_AVAILABLE;
    }

    function normalizePidSchemeTerm(value) {
      if (!value) return '';
      const cleaned = String(value).replace(/\s+/g, ' ').trim();
      if (!cleaned) return '';
      const normalized = normalizeForMatch(cleaned);
      const cleanedLower = cleaned.toLowerCase();
      if (cleanedLower.includes('удк')) return 'UDC';

      const aliases = [
        { re: /\bcross\s*ref\b|\bcrossref\b|\bcrossreff\b|\bcrossref doi\b|\bdoi.*crossref\b|\bcrossref.*doi\b/, canonical: 'CrossRef' },
        { re: /\bdata\s*cite\b|\bdatacite\b|\bdatacitee\b/, canonical: 'DataCite' },
        { re: /\borcid\b/, canonical: 'ORCID' },
        { re: /\bpmcid\b/, canonical: 'PMCID' },
        { re: /\bpmid\b/, canonical: 'PMID' },
        { re: /\bissn\b/, canonical: 'ISSN' },
        { re: /\bdoi\b/, canonical: 'DOI' },
        { re: /\bark\b/, canonical: 'ARK' },
        { re: /\burns?\b/, canonical: 'URN' },
        { re: /\bhandles?\b/, canonical: 'Handle' },
        { re: /\bdors?\b|\bdigital object recognizer\b/, canonical: 'DOR' },
        { re: /\bpurls?\b/, canonical: 'PURL' },
        { re: /\bcoden\b/, canonical: 'CODEN' },
        { re: /\budc\b|\budk\b|\buniversal decimal classification\b|\bудк\b/, canonical: 'UDC' },
        { re: /\bedn\b/, canonical: 'EDN' },
        { re: /\buri\b|\bdc identifier uri\b/, canonical: 'URI' },
        { re: /\bnbn\b/, canonical: 'NBN' },
        { re: /\bgicid\b/, canonical: 'GICID' },
        { re: /\bbiblid\b/, canonical: 'BIBLID' },
        { re: /\bcu\s*id\b/, canonical: 'CU-ID' },
        { re: /\bcrossmark\b/, canonical: 'Crossmark' },
        { re: /\bcstr\b/, canonical: 'CSTR' },
        { re: /\bjel\b/, canonical: 'JEL' },
        { re: /\boai\b/, canonical: 'OAI' },
        { re: /\bqr\b.*\bcode\b/, canonical: 'QR Code' },
        { re: /\bpid\b/, canonical: 'PID' },
        { re: /\bedu\s*nl\b/, canonical: 'Edu.nl' }
      ];

      for (const alias of aliases) {
        if (alias.re.test(normalized)) return alias.canonical;
      }

      if (/https?:\/\/|www\./.test(cleanedLower)) return 'URL';

      return smartTitle(cleaned);
    }

    function getPidSchemes(value) {
      const terms = toValueList(value).map(normalizePidSchemeTerm).filter(Boolean);
      return [...new Set(terms)];
    }

    function normalizePreservationTerm(value) {
      if (!value) return '';
      const cleaned = String(value).replace(/\s+/g, ' ').trim().replace(/[ .;,:-]+$/g, '');
      if (!cleaned) return '';
      const normalized = normalizeForMatch(cleaned);

      const aliases = [
        { re: /\bajol\b|\bafrican journals? online\b/, canonical: 'African Journals Online' },
        { re: /\bzenodo\b|\bzenedo\b|\bzenodoo\b/, canonical: 'Zenodo' },
        { re: /\bclockss\b/, canonical: 'CLOCKSS' },
        { re: /\blockss\b/, canonical: 'LOCKSS' },
        { re: /\bpkp\b.*\bpn\b|\bpkp preservation network\b/, canonical: 'PKP Preservation Network' },
        { re: /\bpkp\s*pln\b|\bpublic knowledge project pln\b/, canonical: 'PKP Preservation Network' },
        { re: /\bportico\b/, canonical: 'Portico' },
        { re: /\bpubmed central\b|\bpmc\b/, canonical: 'PubMed Central' },
        { re: /\binternet archive\b/, canonical: 'Internet Archive' },
        { re: /\bweb archive\b|\barchive org\b/, canonical: 'Internet Archive' },
        { re: /\bcariniana\b/, canonical: 'Cariniana Network' },
        { re: /\bscholars?\s*portal\b/, canonical: 'Scholars Portal' },
        { re: /\bhrcak\b|\bhr cak\b|\bhr ak\b|portal of (croatian|scientific journals of croatia)/, canonical: 'Hrcak Portal of Croatian Scientific Journals' },
        { re: /\be\s*library\b|\belibrary\b|russian electronic scientific library/, canonical: 'eLIBRARY.RU' },
        { re: /\bmagiran\b/, canonical: 'Magiran' },
        { re: /\bnoormags?\b/, canonical: 'Noormags' },
        { re: /\bisc\b|\bislamic world science citation center\b/, canonical: 'Islamic World Science Citation Center' },
        { re: /\bscindeks\b|serbian citation index/, canonical: 'SCIndeks (Serbian Citation Index)' },
        { re: /\bcross\s*ref\b|\bcrossref\b/, canonical: 'CrossRef' },
        { re: /\bkoreamed synapse\b/, canonical: 'KoreaMed Synapse' },
        { re: /\bkoreamed\b/, canonical: 'KoreaMed' },
        { re: /\bceeol\b/, canonical: 'CEEOL' },
        { re: /\bcines\b/, canonical: 'CINES' },
        { re: /\braco\b/, canonical: 'RACO' },
        { re: /\bscience\s*central\b/, canonical: 'Science Central' },
        { re: /\bkorea\s*med\b/, canonical: 'KoreaMed' },
        { re: /\beuro\s*pub\b/, canonical: 'Europub' },
        { re: /\bportal\s*garuda\b/, canonical: 'Garuda' },
        { re: /\bsynapse\b/, canonical: 'KoreaMed Synapse' },
        { re: /\bscholar\b.*\bportal\b/, canonical: 'Scholars Portal' },
        { re: /\buniversity computing centre srce\b/, canonical: 'Hrcak Portal of Croatian Scientific Journals' },
        { re: /\bgoogle scholar\b/, canonical: 'Google Scholar' },
        { re: /\bsid\b/, canonical: 'SID' },
        { re: /\bniscpr online periodicals repository\b/, canonical: 'NIScPR Online Periodicals Repository' },
        { re: /\bin[- ]?house archiving\b/, canonical: 'In-house Archiving' },
        { re: /\bjournal'?s?\s+website\b|\bjournal\s+s?\s+website\b|\bjournal\s+website\b|\bwebsite of the journal\b|\barchived in the journal\b|\bissues of the journal\b/, canonical: 'Journal Website' },
        { re: /\bnational digital archives of iranian scholarly journals\b/, canonical: 'National Digital Archives of Iranian Scholarly Journals' },
        { re: /\be\s*depot\b/, canonical: 'E-Depot' },
        { re: /\bnational library of the netherlands\b|\bkoninklijke bibliotheek\b|\bkb\b/, canonical: 'KB National Library of the Netherlands' }
      ];

      for (const alias of aliases) {
        if (alias.re.test(normalized)) return alias.canonical;
      }

      if (/https?:\/\/|www\./i.test(cleaned)) {
        const urlAliases = [
          { re: /\bhrcak\b/, canonical: 'Hrcak Portal of Croatian Scientific Journals' },
          { re: /\belibrary\b|\bru\b/, canonical: 'eLIBRARY.RU' },
          { re: /\bkoreamed\b/, canonical: 'KoreaMed' },
          { re: /\bscholar\b/, canonical: 'Google Scholar' },
          { re: /\barchive\b|\bjournal\b|\brepository\b/, canonical: 'Journal Website' }
        ];
        for (const alias of urlAliases) {
          if (alias.re.test(normalized)) return alias.canonical;
        }
        return 'Journal Website';
      }

      const paren = cleaned.match(/\(([^)]+)\)/);
      if (paren) {
        const inner = paren[1].replace(/\s+/g, ' ').trim();
        if (inner.length > 4 && inner.includes(' ')) return inner;
      }

      return smartTitle(cleaned);
    }

    function getPreservationTerms(value) {
      const terms = toValueList(value).map(normalizePreservationTerm).filter(Boolean);
      return [...new Set(terms)];
    }

    function normalizePeerReviewTerm(value) {
      if (!value) return '';
      const cleaned = String(value).replace(/\s+/g, ' ').trim();
      if (!cleaned) return '';
      const normalized = normalizeForMatch(cleaned);

      const aliases = [
        { re: /\bpartial\b.*\bdouble\b.*\b(anonymous|blind)\b|\bdouble\b.*\b(anonymous|blind)\b/, canonical: 'Double anonymous peer review' },
        { re: /\btriple\b.*\b(anonymous|blind)\b/, canonical: 'Triple anonymous peer review' },
        { re: /\bopen peer commentary\b|\bopen\b.*\bpeer\b.*\breview\b/, canonical: 'Open peer review' },
        { re: /\bpost publication\b.*\bpeer\b.*\breview\b/, canonical: 'Post-publication peer review' },
        { re: /\bcrowd\b.*\breview\b/, canonical: 'Crowd review' },
        { re: /\bcommittee\b.*\breview\b/, canonical: 'Committee review' },
        { re: /\b(editorial review|collaborative editorial)\b/, canonical: 'Editorial review' },
        { re: /\b(single|anonymous|blind)\b.*\bpeer\b.*\breview\b|\banonymous peer review\b/, canonical: 'Anonymous peer review' },
        { re: /\bpeer\b.*\breview\b/, canonical: 'Peer review' }
      ];

      for (const alias of aliases) {
        if (alias.re.test(normalized)) return alias.canonical;
      }
      return smartTitle(cleaned);
    }

    function getPeerReviewTerms(value) {
      const terms = toValueList(value).map(normalizePeerReviewTerm).filter(Boolean);
      return [...new Set(terms)];
    }

    function normalizeDepositPolicyTerm(value) {
      if (!value) return '';
      const cleaned = String(value).replace(/\s+/g, ' ').trim().replace(/[ .;,:-]+$/g, '');
      if (!cleaned) return '';
      const normalized = normalizeForMatch(cleaned);

      const aliases = [
        { re: /\bopen policy finder\b|\bsherpa\s*romeo\b/, canonical: 'Open Policy Finder' },
        { re: /\bdiadorim\b/, canonical: 'Diadorim' },
        { re: /\bdulcinea\b/, canonical: 'Dulcinea' },
        { re: /\bmir\s*bel\b|\bmirabel\b/, canonical: 'Mir@bel' },
        { re: /\bmalena\b/, canonical: 'Malena' },
        { re: /\baura\b/, canonical: 'AURA' },
        { re: /\bdergi\s*park\b/, canonical: 'DergiPark' },
        { re: /\bgaruda\b|\bgarba rujukan digital\b/, canonical: 'Garuda' },
        { re: /\b(publisher|publishers|pulisher|pulishers)\b.*\b(site|website)\b|\b(publisher|publishers|pulisher|pulishers)\b.*\bown\b.*\b(site|website)\b/, canonical: "Publisher's own site" },
        { re: /\bjournal\b.*\bown\b.*\b(site|website)\b|\bjournal own website\b/, canonical: "Journal's own site" },
        { re: /\bjournal\b.*\b(site|website)\b/, canonical: 'Journal website' },
        { re: /\bpreprint\b.*\bpostprint\b.*\bpolicy\b/, canonical: 'Preprint and postprint policy' },
        { re: /\bpre[- ]?print\b.*\bpost[- ]?print\b.*\bdeposition\b.*\bpolicy\b/, canonical: 'Preprint and postprint policy' },
        { re: /\bself\b.*\barchiving\b/, canonical: 'Self-archiving policy' },
        { re: /\brepository\b.*\bpolicy\b/, canonical: 'Repository policy' },
        { re: /\bin[- ]?house\b.*\brepository\b/, canonical: 'In-house repository' },
        { re: /\bcopyright\b/, canonical: 'Copyright notice' },
        { re: /\bauthors?\b.*\brights?\b/, canonical: "Authors' rights" },
        { re: /\bauthors?\b.*\bpersonal\b.*\binstitutional\b.*\brepositor/, canonical: "Authors' personal and institutional repositories" },
        { re: /\binstruction(s)?\s+to\s+authors\b|\binstructions?\s+for\s+authors\b/, canonical: 'Instructions for authors' },
        { re: /\bopen access statement\b|\bopen access policy\b/, canonical: 'Open access policy' },
        { re: /\binstitutional\b.*\brepository\b/, canonical: 'Institutional repository' },
        { re: /\bbrill\b/, canonical: 'Brill.com' },
        { re: /\bour own site\b/, canonical: "Publisher's own site" },
        { re: /\bpublic and\s+or commercial subject based repositories\b/, canonical: 'Public and/or commercial subject-based repositories' },
        { re: /\bkarger permits authors of open access articles\b/, canonical: 'Karger policy statement' },
        { re: /\bvcgate\b/, canonical: 'VCgate' },
        { re: /\bvjol\b/, canonical: 'VJOL' },
        { re: /\bscpj\b/, canonical: 'SCPJ' },
        { re: /\bojs\s*\/?\s*pkp\b/, canonical: 'OJS/PKP' },
        { re: /\blockss\b/, canonical: 'LOCKSS' },
        { re: /\bcross\s*ref\b|\bcrossref\b/, canonical: 'CrossRef' }
      ];

      for (const alias of aliases) {
        if (alias.re.test(normalized)) return alias.canonical;
      }

      if (/https?:\/\/|www\./i.test(cleaned)) {
        const urlAliases = [
          { re: /\bdergi\s*park\b/, canonical: 'DergiPark' },
          { re: /\bsherpa\b|\bromeo\b|\bopen policy finder\b/, canonical: 'Open Policy Finder' },
          { re: /\bcreative\s*commons\b/, canonical: 'Creative Commons' },
          { re: /\barxiv\b/, canonical: 'arXiv' },
          { re: /\bzenodo\b/, canonical: 'Zenodo' },
          { re: /\bfairsharing\b/, canonical: 'FAIRsharing' }
        ];
        for (const alias of urlAliases) {
          if (alias.re.test(normalized)) return alias.canonical;
        }
        return 'Journal website';
      }
      if (/\bpublisher\b/.test(normalized) && /\b(site|website)\b/.test(normalized)) return "Publisher's own site";
      if (/\bjournal\b/.test(normalized) && /\b(site|website)\b/.test(normalized)) return 'Journal website';
      return smartTitle(cleaned);
    }

    function getDepositPolicyTerms(value) {
      const terms = toValueList(value).map(normalizeDepositPolicyTerm).filter(Boolean);
      return [...new Set(terms)];
    }

    function titleCase(value) {
      return String(value)
        .toLowerCase()
        .replace(/\b([a-z])/g, ch => ch.toUpperCase());
    }

    function formatCountry(country) {
      if (!country) return NOT_AVAILABLE;
      const raw = String(country).trim();
      const cleaned = raw.replace(/_/g, ' ');
      const upper = cleaned.toUpperCase();

      if (/^[A-Z]{2}$/.test(upper) && countryNameFormatter) {
        const resolved = countryNameFormatter.of(upper);
        if (resolved && resolved !== upper) return resolved;
      }

      if (/^[A-Z][A-Z\s-]{3,}$/.test(cleaned)) {
        return titleCase(cleaned);
      }

      return cleaned;
    }

    function shortLabel(text, maxLen = 45) {
      if (!text) return '—';
      const value = String(text);
      return value.length <= maxLen ? value : `${value.slice(0, maxLen - 3)}...`;
    }

    function getContinent(country) {
      if (!country) return 'Other';
      return COUNTRY_TO_CONTINENT[country] || 'Other';
    }

    function getCountryContinent(country) {
      const direct = getContinent(country);
      if (direct !== 'Other') return direct;
      const formatted = formatCountry(country);
      return getContinent(formatted);
    }

    function getCreatedYear(record) {
      if (!record || !record.created_date) return null;
      const year = new Date(record.created_date).getUTCFullYear();
      return Number.isNaN(year) ? null : year;
    }

    function getArticleRecords(record) {
      if (!record) return null;
      const raw = record.article_records;
      if (raw === null || raw === undefined || raw === '') return null;
      const num = Number(raw);
      if (Number.isFinite(num)) return Math.trunc(num);
      const match = String(raw).replace(/,/g, '').match(/-?\d+/);
      return match ? Number(match[0]) : null;
    }

    function normalizeCurrencyCode(value) {
      if (value === null || value === undefined) return '';
      const text = String(value).trim().toUpperCase();
      const match = text.match(/\b([A-Z]{3})\b/);
      return match ? match[1] : '';
    }

    function parseApcRawEntries(rawValue) {
      if (!rawValue) return [];
      const segments = String(rawValue).split(/[;\n|]+/).map(part => part.trim()).filter(Boolean);
      const entries = [];
      for (const segment of segments) {
        const compact = segment.replace(/(\d)\s+(?=\d)/g, '$1');
        const amountMatch = compact.replace(/,/g, '').match(/-?\d+(\.\d+)?/);
        const currencyCode = normalizeCurrencyCode(segment);
        if (!amountMatch || !currencyCode) continue;
        const amount = Number(amountMatch[0]);
        if (!Number.isFinite(amount)) continue;
        entries.push({ amount, currency: currencyCode });
      }
      return entries;
    }

    function getApcAmountEntries(record) {
      if (!record) return [];
      const fromStructured = Array.isArray(record.apc_amounts)
        ? record.apc_amounts
            .map(item => {
              const amount = Number(item && item.amount);
              const currency = normalizeCurrencyCode(item && item.currency);
              if (!Number.isFinite(amount) || !currency) return null;
              return { amount, currency };
            })
            .filter(Boolean)
        : [];
      if (fromStructured.length) return fromStructured;

      const fromRaw = parseApcRawEntries(record.apc_amount_raw);
      if (fromRaw.length) return fromRaw;

      const fallbackAmount = Number(record.apc_max_price);
      const fallbackCurrency = normalizeCurrencyCode(record.apc_max_currency);
      if (Number.isFinite(fallbackAmount) && fallbackCurrency) {
        return [{ amount: fallbackAmount, currency: fallbackCurrency }];
      }
      return [];
    }

    function convertToEur(amount, currency) {
      if (!Number.isFinite(amount)) return null;
      const code = normalizeCurrencyCode(currency);
      if (!code) return null;
      if (code === 'EUR') return amount;
      if (!state.fxRates || !Object.prototype.hasOwnProperty.call(state.fxRates, code)) return null;
      const rate = Number(state.fxRates[code]);
      if (!Number.isFinite(rate) || rate <= 0) return null;
      return amount / rate;
    }

    function convertFromEur(amount, currency) {
      if (!Number.isFinite(amount)) return null;
      const code = normalizeCurrencyCode(currency);
      if (!code) return null;
      if (code === 'EUR') return amount;
      if (!state.fxRates || !Object.prototype.hasOwnProperty.call(state.fxRates, code)) return null;
      const rate = Number(state.fxRates[code]);
      if (!Number.isFinite(rate) || rate <= 0) return null;
      return amount * rate;
    }

    function getMaxApcEur(record) {
      if (!record || record.apc_has !== true) return null;
      const entries = getApcAmountEntries(record);
      if (!entries.length) return null;
      let maxEur = null;
      for (const entry of entries) {
        const eurAmount = convertToEur(entry.amount, entry.currency);
        if (!Number.isFinite(eurAmount)) continue;
        if (maxEur === null || eurAmount > maxEur) maxEur = eurAmount;
      }
      return maxEur;
    }

    function getMaxApcInCurrency(record, targetCurrency = 'EUR') {
      const currency = normalizeCurrencyCode(targetCurrency) || 'EUR';
      const maxEur = getMaxApcEur(record);
      if (!Number.isFinite(maxEur)) return null;
      if (currency === 'EUR') return maxEur;
      return convertFromEur(maxEur, currency);
    }

    function formatCurrencyWhole(value, currency = 'EUR') {
      if (!Number.isFinite(value)) return '0';
      const code = normalizeCurrencyCode(currency) || 'EUR';
      return `${code} ${Math.round(value).toLocaleString()}`;
    }

    function getSelectedApcCurrency() {
      const select = document.getElementById('apc-currency');
      const selected = select ? select.value : 'EUR';
      const code = normalizeCurrencyCode(selected);
      return code === 'USD' ? 'USD' : 'EUR';
    }

    function isOverOneMonth(record) {
      if (!record || !record.created_date) return false;
      const created = new Date(record.created_date);
      if (Number.isNaN(created.getTime())) return false;
      return Date.now() - created.getTime() > (30 * 24 * 60 * 60 * 1000);
    }

    function sumArticleRecords(records) {
      return records.reduce((sum, r) => {
        const value = getArticleRecords(r);
        return sum + (value === null ? 0 : value);
      }, 0);
    }

    function sortedEntries(counterObj, limit) {
      const entries = Object.entries(counterObj).sort((a, b) => b[1] - a[1]);
      return typeof limit === 'number' ? entries.slice(0, limit) : entries;
    }

    function countTermFrequency(records, termExtractor, includeNotAvailable = false) {
      const counts = {};
      for (const record of records) {
        const terms = [...new Set((termExtractor(record) || []).filter(Boolean))];
        if (!terms.length) {
          if (includeNotAvailable) {
            counts[NOT_AVAILABLE] = (counts[NOT_AVAILABLE] || 0) + 1;
          }
          continue;
        }
        for (const term of terms) {
          counts[term] = (counts[term] || 0) + 1;
        }
      }
      return counts;
    }

    function maxCounterValue(counterObj) {
      const values = Object.values(counterObj || {}).map(v => Number(v) || 0);
      return values.length ? Math.max(...values) : 0;
    }

    function computeMedian(values) {
      if (!Array.isArray(values) || !values.length) return null;
      const sorted = values
        .map(value => Number(value))
        .filter(value => Number.isFinite(value))
        .sort((a, b) => a - b);
      if (!sorted.length) return null;
      const middle = Math.floor(sorted.length / 2);
      if (sorted.length % 2 === 0) {
        return (sorted[middle - 1] + sorted[middle]) / 2;
      }
      return sorted[middle];
    }

    function computeAverage(values) {
      if (!Array.isArray(values) || !values.length) return null;
      let sum = 0;
      let count = 0;
      for (const value of values) {
        const numeric = Number(value);
        if (!Number.isFinite(numeric)) continue;
        sum += numeric;
        count += 1;
      }
      if (!count) return null;
      return sum / count;
    }

    function quantile(values, q) {
      if (!Array.isArray(values) || !values.length) return 0;
      const sorted = values
        .map(v => Number(v))
        .filter(v => Number.isFinite(v))
        .sort((a, b) => a - b);
      if (!sorted.length) return 0;
      const pos = (sorted.length - 1) * q;
      const base = Math.floor(pos);
      const rest = pos - base;
      const next = sorted[Math.min(base + 1, sorted.length - 1)];
      return sorted[base] + (next - sorted[base]) * rest;
    }

    function normalizeIssn(value) {
      if (!value) return '';
      const cleaned = String(value).toUpperCase().replace(/[^0-9X]/g, '');
      if (cleaned.length === 8) return cleaned.slice(0, 4) + '-' + cleaned.slice(4);
      if (cleaned.length === 9 && cleaned[4] === '-') return cleaned;
      return '';
    }

    function getIssnSet(record) {
      const issns = [];
      [record.pissn, record.eissn].forEach(val => {
        if (!val) return;
        String(val).split(/[,;|]/).forEach(part => {
          const norm = normalizeIssn(part);
          if (norm) issns.push(norm);
        });
      });
      const seen = new Set();
      return issns.filter(x => !seen.has(x) && seen.add(x));
    }

    function computeOverlap(doajRecords, sjrRecords) {
      if (!Array.isArray(doajRecords) || !Array.isArray(sjrRecords)) return [];
      const sjrByIssn = new Map();
      for (const rec of sjrRecords) {
        if (!rec || !Array.isArray(rec.issns)) continue;
        for (const issn of rec.issns) {
          const norm = normalizeIssn(issn);
          if (!norm) continue;
          if (!sjrByIssn.has(norm)) sjrByIssn.set(norm, []);
          sjrByIssn.get(norm).push(rec);
        }
      }
      const overlap = [];
      for (const rec of doajRecords) {
        const issnSet = getIssnSet(rec);
        let sjrMatches = [];
        for (const issn of issnSet) {
          if (sjrByIssn.has(issn)) {
            sjrMatches = sjrByIssn.get(issn);
            break;
          }
        }
        if (!sjrMatches.length) continue;
        const s = sjrMatches[0];
        overlap.push({
          title: rec.title || s.title,
          doajCountry: formatCountry(rec.country),
          sjrCountry: formatCountry(s.country),
          quartile: s.quartile || NOT_AVAILABLE,
          sjr: Number(s.sjr) || 0,
          hIndex: Number(s.h_index) || 0,
          citesPerDoc: Number(s.cites_per_doc2) || 0,
          cites3y: Number(s.cites3y) || 0,
          areas: Array.isArray(s.areas) ? s.areas : [],
          issns: issnSet.length ? issnSet : (s.issns || [])
        });
      }
      return overlap;
    }

    function computeOverlapStats(overlap) {
      if (!Array.isArray(overlap) || !overlap.length) return null;
      const stats = {};
      stats.count = overlap.length;
      const quartiles = {};
      const citesByQuartile = {};
      const hValues = [];
      const sjrValues = [];
      const countryCounts = {};
      const areaCounts = {};

      overlap.forEach(item => {
        const q = item.quartile || NOT_AVAILABLE;
        quartiles[q] = (quartiles[q] || 0) + 1;
        if (!citesByQuartile[q]) citesByQuartile[q] = [];
        if (item.citesPerDoc) citesByQuartile[q].push(item.citesPerDoc);
        if (item.hIndex) hValues.push(item.hIndex);
        if (item.sjr) sjrValues.push(item.sjr);
        if (item.sjrCountry) {
          countryCounts[item.sjrCountry] = (countryCounts[item.sjrCountry] || 0) + 1;
        }
        (item.areas || []).forEach(area => {
          if (!area) return;
          areaCounts[area] = (areaCounts[area] || 0) + 1;
        });
      });

      stats.quartiles = quartiles;
      stats.avgCitesByQuartile = Object.fromEntries(Object.entries(citesByQuartile).map(([k, arr]) => [k, computeAverage(arr) || 0]));
      stats.hIndex = {
        p10: quantile(hValues, 0.10),
        median: quantile(hValues, 0.50),
        p90: quantile(hValues, 0.90)
      };
      stats.sjr = {
        min: sjrValues.length ? Math.min(...sjrValues) : 0,
        median: quantile(sjrValues, 0.50),
        p90: quantile(sjrValues, 0.90)
      };
      const sortCounts = obj => Object.entries(obj).sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]));
      stats.topCountries = sortCounts(countryCounts).slice(0, 10);
      stats.topAreas = sortCounts(areaCounts).slice(0, 10);
      return stats;
    }

    function getApcCountryStats(records, currency = 'EUR') {
      const byCountry = {};
      for (const record of records || []) {
        if (!record || record.apc_has !== true) continue;
        const countryName = formatCountry(record.country);
        if (!countryName || countryName === NOT_AVAILABLE) continue;
        const currencyValue = getMaxApcInCurrency(record, currency);
        if (!Number.isFinite(currencyValue) || currencyValue < 0) continue;

        if (!byCountry[countryName]) {
          byCountry[countryName] = {
            country: countryName,
            continent: getCountryContinent(record.country),
            count: 0,
            values: []
          };
        }
        byCountry[countryName].count += 1;
        byCountry[countryName].values.push(currencyValue);
      }

      return Object.values(byCountry)
        .map(entry => ({
          country: entry.country,
          continent: entry.continent,
          count: entry.count,
          median: computeMedian(entry.values),
          average: computeAverage(entry.values)
        }))
        .filter(entry => Number.isFinite(entry.median) && Number.isFinite(entry.average))
        .sort((a, b) => {
          if (b.count !== a.count) return b.count - a.count;
          if (b.median !== a.median) return b.median - a.median;
          return a.country.localeCompare(b.country);
        });
    }

    function buildMonthlyTimeline(records) {
      const monthCounts = {};
      let minMonthTime = null;
      let maxMonthTime = null;

      for (const record of records || []) {
        if (!record || !record.created_date) continue;
        const date = new Date(record.created_date);
        if (Number.isNaN(date.getTime())) continue;
        const monthTime = Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), 1);
        monthCounts[monthTime] = (monthCounts[monthTime] || 0) + 1;
        if (minMonthTime === null || monthTime < minMonthTime) minMonthTime = monthTime;
        if (maxMonthTime === null || monthTime > maxMonthTime) maxMonthTime = monthTime;
      }

      if (minMonthTime === null || maxMonthTime === null) {
        return { dates: [], counts: [], movingAvg: [] };
      }

      const dates = [];
      const counts = [];
      let cursor = new Date(minMonthTime);
      const endDate = new Date(maxMonthTime);
      while (cursor <= endDate) {
        const monthTime = Date.UTC(cursor.getUTCFullYear(), cursor.getUTCMonth(), 1);
        dates.push(new Date(monthTime).toISOString().slice(0, 10));
        counts.push(monthCounts[monthTime] || 0);
        cursor = new Date(Date.UTC(cursor.getUTCFullYear(), cursor.getUTCMonth() + 1, 1));
      }

      const movingAvg = counts.map((_, idx) => {
        const startIdx = Math.max(0, idx - 2);
        const window = counts.slice(startIdx, idx + 1);
        const avg = window.reduce((sum, value) => sum + value, 0) / window.length;
        return Math.round(avg * 10) / 10;
      });

      return { dates, counts, movingAvg };
    }

    function computeChartScales(records) {
      const scales = {};

      const countryCounts = {};
      const publisherCounts = {};
      const continentCounts = {};

      for (const record of records) {
        const country = record.country;
        if (country) {
          countryCounts[country] = (countryCounts[country] || 0) + 1;
          const continent = getContinent(country);
          continentCounts[continent] = (continentCounts[continent] || 0) + 1;
        }

        const publisher = (record.publisher || '').trim();
        if (publisher) publisherCounts[publisher] = (publisherCounts[publisher] || 0) + 1;

      }

      const subjectCounts = countTermFrequency(records, r => toValueList(r.subject_terms));
      const languageCounts = countTermFrequency(records, r => getSimpleTerms(r.language));
      const licenseCounts = countTermFrequency(records, r => toValueList(r.license_type));
      const peerCounts = countTermFrequency(records, r => getPeerReviewTerms(r.peer_review_type), true);
      const pidCounts = countTermFrequency(records, r => getPidSchemes(r.pid_scheme), true);
      const preservationCounts = countTermFrequency(records, r => getPreservationTerms(r.preservation_service), true);
      const timelineSeries = buildMonthlyTimeline(records);
      const apcCountryStats = getApcCountryStats(records);
      const apcCountryMedianMax = apcCountryStats.length ? Math.max(...apcCountryStats.map(entry => entry.median)) : 0;

      scales.countryMax = maxCounterValue(countryCounts);
      scales.continentMax = maxCounterValue(continentCounts);
      scales.subjectMax = maxCounterValue(subjectCounts);
      scales.languageMax = maxCounterValue(languageCounts);
      scales.licenseMax = maxCounterValue(licenseCounts);
      scales.peerMax = maxCounterValue(peerCounts);
      scales.pidMax = maxCounterValue(pidCounts);
      scales.preservationMax = maxCounterValue(preservationCounts);
      scales.publisherMax = maxCounterValue(publisherCounts);
      scales.timelineMax = Math.max(...timelineSeries.counts, ...timelineSeries.movingAvg, 0);
      scales.apcCountryMedianMax = apcCountryMedianMax;
      scales.mapCountryMax = scales.countryMax;

      return scales;
    }

    function buildSearchTerms(records) {
      const terms = new Set();
      for (const record of records) {
        const title = (record.title || '').trim();
        if (title) terms.add(title);

        const country = formatCountry(record.country);
        if (country && country !== NOT_AVAILABLE) terms.add(country);

        for (const subject of toValueList(record.subject_terms)) {
          const cleaned = String(subject).trim();
          if (cleaned) terms.add(cleaned);
        }
      }
      state.searchTerms = [...terms].sort((a, b) => a.localeCompare(b));
    }

    function renderNoDataChart(targetId, title) {
      Plotly.newPlot(
        targetId,
        [],
        {
          title,
          paper_bgcolor: 'rgba(0,0,0,0)',
          plot_bgcolor: 'rgba(0,0,0,0)',
          font: { color: '#282624' },
          xaxis: { visible: false },
          yaxis: { visible: false },
          annotations: [{ text: 'No data yet', showarrow: false, xref: 'paper', yref: 'paper', x: 0.5, y: 0.5 }]
        },
        { displayModeBar: false }
      );
    }

    function renderHorizontalBarChart(targetId, title, entries, opts = {}) {
      if (!entries.length) {
        renderNoDataChart(targetId, title);
        return;
      }

      const labelFormatter = opts.labelFormatter || (v => v);
      const labels = entries.map(d => labelFormatter(d[0]));
      const values = entries.map(d => d[1]);
      const colors = opts.colors || labels.map(() => (opts.color || '#3A5959'));
      const plotX = values.slice().reverse();
      const plotY = labels.slice().reverse();
      const plotColors = colors.slice().reverse();
      const plotText = plotX.map(v => Number(v || 0).toLocaleString());
      const maxValue = Math.max(Number(opts.fixedMax) || 0, ...values.map(v => Number(v || 0)), 0);
      const xPad = maxValue > 0 ? Math.max(1, maxValue * 0.12) : 1;

      Plotly.newPlot(
        targetId,
        [{
          type: 'bar',
          orientation: 'h',
          x: plotX,
          y: plotY,
          marker: { color: plotColors },
          text: plotText,
          textposition: 'inside',
          insidetextanchor: 'end',
          constraintext: 'inside',
          textfont: { color: '#FFFFFF', size: 12 },
          cliponaxis: true
        }],
        {
          title,
          margin: { l: opts.leftMargin || 280, r: opts.rightMargin || 44, t: 46, b: 48 },
          paper_bgcolor: 'rgba(0,0,0,0)',
          plot_bgcolor: 'rgba(0,0,0,0)',
          font: { color: '#282624' },
          xaxis: { tickformat: ',d', separatethousands: true, range: [0, maxValue + xPad], ticklabeloverflow: 'hide past div' },
          yaxis: { automargin: true, ticklabelstandoff: 12, ticks: 'outside', ticklen: 4, ticklabeloverflow: 'hide past div' }
        },
        { displayModeBar: false }
      );
    }

    function renderYesNoShareChart(targetId, title, yesCount, noCount, opts = {}) {
      const yes = Number(yesCount) || 0;
      const no = Number(noCount) || 0;
      const total = yes + no;

      if (total <= 0) {
        renderNoDataChart(targetId, title);
        return;
      }

      const yesPct = (yes / total) * 100;
      const noPct = (no / total) * 100;

      Plotly.newPlot(
        targetId,
        [{
          type: 'bar',
          orientation: 'h',
          name: 'Yes',
          y: ['Share'],
          x: [yesPct],
          customdata: [yes],
          text: [`${yesPct.toFixed(1)}%`],
          textposition: 'inside',
          marker: { color: opts.yesColor || '#47A178' },
          hovertemplate: 'Yes: %{customdata:,d} journals (%{x:.1f}%)<extra></extra>',
          textfont: { color: '#FFFFFF', size: 12 },
          cliponaxis: false
        }, {
          type: 'bar',
          orientation: 'h',
          name: 'No',
          y: ['Share'],
          x: [noPct],
          customdata: [no],
          text: [`${noPct.toFixed(1)}%`],
          textposition: 'inside',
          marker: { color: opts.noColor || '#FD5A3B' },
          hovertemplate: 'No: %{customdata:,d} journals (%{x:.1f}%)<extra></extra>',
          textfont: { color: '#FFFFFF', size: 12 },
          cliponaxis: false
        }],
        {
          title,
          barmode: 'stack',
          margin: { l: 20, r: 44, t: 56, b: 44 },
          paper_bgcolor: 'rgba(0,0,0,0)',
          plot_bgcolor: 'rgba(0,0,0,0)',
          font: { color: '#282624' },
          xaxis: { range: [0, 100], ticksuffix: '%', dtick: 20 },
          yaxis: { visible: false },
          showlegend: true,
          legend: { orientation: 'h', x: 0, y: -0.24 },
          annotations: [{
            text: `Total journals: ${formatNumber(total)}`,
            showarrow: false,
            xref: 'paper',
            yref: 'paper',
            x: 1,
            y: 1.22,
            xanchor: 'right',
            font: { size: 12, color: '#5C5956' }
          }]
        },
        { displayModeBar: false }
      );
    }

    function renderApcCountryChart(targetId, title, stats, opts = {}) {
      const limit = Math.max(1, Number(opts.limit) || 20);
      const desiredColumns = Math.max(1, Number(opts.columns) || 3);
      const currency = normalizeCurrencyCode(opts.currency) || 'EUR';
      const ordered = (stats || []).slice(0, limit);
      if (!ordered.length) {
        renderNoDataChart(targetId, title);
        return;
      }

      const columns = [];
      const rowsPerColumn = Math.ceil(ordered.length / desiredColumns);
      for (let index = 0; index < desiredColumns; index += 1) {
        const chunk = ordered.slice(index * rowsPerColumn, (index + 1) * rowsPerColumn);
        if (chunk.length) columns.push(chunk);
      }

      const maxMedian = Math.max(Number(opts.fixedMax) || 0, ...ordered.map(entry => Number(entry.median) || 0), 1);
      const xPad = Math.max(120, maxMedian * 0.28);
      const xLimit = maxMedian + xPad;
      const traces = [];
      const layoutHeight = Math.max(420, rowsPerColumn * 34 + 150);
      const columnGutter = columns.length === 1 ? 0.02 : (columns.length === 2 ? 0.24 : 0.14);
      const layout = {
        title: {
          text: title,
          x: 0.5,
          xanchor: 'center'
        },
        height: layoutHeight,
        grid: {
          rows: 1,
          columns: columns.length,
          pattern: 'independent',
          xgap: columnGutter
        },
        margin: { l: 136, r: 92, t: 72, b: 68 },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { color: '#282624' },
        showlegend: false
      };

      columns.forEach((columnData, idx) => {
        const axisNumber = idx + 1;
        const axisSuffix = axisNumber === 1 ? '' : String(axisNumber);
        const traceAxisSuffix = axisNumber === 1 ? '' : String(axisNumber);
        const reversed = columnData.slice().reverse();
        const labels = reversed.map(entry => shortLabel(entry.country, 26));
        const values = reversed.map(entry => Math.round(entry.median));
        const valueText = values.map(value => `${currency} ${value.toLocaleString()}`);
        const customData = reversed.map(entry => [
          entry.country,
          entry.count,
          Math.round(entry.median),
          Math.round(entry.average),
          entry.continent
        ]);
        const barColors = reversed.map(entry => CONTINENT_COLORS[entry.continent] || CONTINENT_COLORS.Other);

        traces.push({
          type: 'bar',
          orientation: 'h',
          x: values,
          y: labels,
          marker: { color: barColors },
          text: valueText,
          textposition: 'outside',
          cliponaxis: false,
          customdata: customData,
          hovertemplate: `%{customdata[0]}<br>Median APC: ${currency} %{customdata[2]:,d}<br>Average APC: ${currency} %{customdata[3]:,d}<br>APC journals: %{customdata[1]:,d}<br>Continent: %{customdata[4]}<extra></extra>`,
          xaxis: `x${traceAxisSuffix}`,
          yaxis: `y${traceAxisSuffix}`
        });

        const xAxisKey = `xaxis${axisSuffix}`;
        const yAxisKey = `yaxis${axisSuffix}`;
        layout[xAxisKey] = {
          range: [0, xLimit],
          tickformat: ',d',
          separatethousands: true,
          ticklabeloverflow: 'hide past div'
        };
        layout[yAxisKey] = {
          automargin: true,
          ticklabelstandoff: 12,
          ticks: 'outside',
          ticklen: 4,
          ticklabeloverflow: 'hide past div'
        };

      });

      Plotly.newPlot(targetId, traces, layout, { displayModeBar: false });
    }

    function syncYearLabels() {
      const minEl = document.getElementById('year-min-label');
      const maxEl = document.getElementById('year-max-label');
      if (!state.yearBounds) {
        minEl.textContent = '—';
        maxEl.textContent = '—';
        return;
      }
      minEl.textContent = String(state.yearBounds.min);
      maxEl.textContent = String(state.yearBounds.max);
    }

    function setupYearRange() {
      const fromEl = document.getElementById('year-from');
      const toEl = document.getElementById('year-to');
      const years = state.records.map(getCreatedYear).filter(y => y !== null);

      if (!years.length) {
        state.yearBounds = null;
        fromEl.disabled = true;
        toEl.disabled = true;
        fromEl.value = '';
        toEl.value = '';
        syncYearLabels();
        return;
      }

      const min = Math.min(...years);
      const max = Math.max(...years);
      state.yearBounds = { min, max };

      fromEl.disabled = false;
      toEl.disabled = false;
      fromEl.min = String(min);
      fromEl.max = String(max);
      toEl.min = String(min);
      toEl.max = String(max);

      if (!fromEl.value || Number.isNaN(parseInt(fromEl.value, 10))) fromEl.value = String(min);
      if (!toEl.value || Number.isNaN(parseInt(toEl.value, 10))) toEl.value = String(max);
      if (parseInt(fromEl.value, 10) < min) fromEl.value = String(min);
      if (parseInt(fromEl.value, 10) > max) fromEl.value = String(max);
      if (parseInt(toEl.value, 10) < min) toEl.value = String(min);
      if (parseInt(toEl.value, 10) > max) toEl.value = String(max);
      if (parseInt(fromEl.value, 10) > parseInt(toEl.value, 10)) fromEl.value = toEl.value;

      syncYearLabels();
    }

    function resetYearRange() {
      const fromEl = document.getElementById('year-from');
      const toEl = document.getElementById('year-to');
      if (!state.yearBounds) {
        fromEl.value = '';
        toEl.value = '';
      } else {
        fromEl.value = String(state.yearBounds.min);
        toEl.value = String(state.yearBounds.max);
      }
      syncYearLabels();
    }

    async function loadJsonOrNull(path) {
      try {
        const res = await fetch(path, { cache: 'no-store' });
        if (!res.ok) return null;
        return await res.json();
      } catch (_err) {
        return null;
      }
    }

    async function loadSjrDataset() {
      const cacheBust = Date.now();
      // Try JSON first
      const sjrJson = await loadJsonOrNull(`data/sjr.json?v=${cacheBust}`);
      if (Array.isArray(sjrJson) && sjrJson.length) return sjrJson;
      // Fallback to CSV if JSON not available
      try {
        const res = await fetch(`data/scimagojr.csv?v=${cacheBust}`, { cache: 'no-store' });
        if (!res.ok) return [];
        const text = await res.text();
        if (!window.Papa) return [];
        const parsed = Papa.parse(text, { header: true, delimiter: ';', skipEmptyLines: true });
        if (!parsed.data || !parsed.data.length) return [];
        return parsed.data.map(row => normalizeSjrRow(row)).filter(Boolean);
      } catch (_err) {
        return [];
      }
    }

    function normalizeSjrRow(row) {
      if (!row) return null;
      const toNum = val => {
        const num = Number(String(val).replace(',', '.'));
        return Number.isFinite(num) ? num : null;
      };
      const issnsRaw = row.Issn || row.ISSN || '';
      const issns = String(issnsRaw)
        .replace(/\"/g, '')
        .split(',')
        .map(normalizeIssn)
        .filter(Boolean);
      const areasRaw = row.Areas || '';
      const areas = String(areasRaw)
        .split(';')
        .map(s => s.trim())
        .filter(Boolean);
      return {
        id: String(row.Sourceid || row.sourceid || '').trim(),
        title: String(row.Title || row.title || '').trim(),
        issns,
        sjr: toNum(row.SJR),
        quartile: String(row['SJR Best Quartile'] || row.quartile || '').trim(),
        h_index: toNum(row['H index']),
        cites3y: toNum(row['Total Citations (3years)']),
        cites_per_doc2: toNum(row['Citations / Doc. (2years)']),
        country: String(row.Country || '').trim(),
        areas
      };
    }

    async function loadData() {
      const [journalsRes, aggRes, metaRes] = await Promise.all([
        loadJsonOrNull('data/journals.json'),
        loadJsonOrNull('data/aggregates.json'),
        loadJsonOrNull('data/meta.json')
      ]);

      if (!Array.isArray(journalsRes) || journalsRes.length === 0) {
        state.records = [];
        state.filtered = [];
        state.aggregates = aggRes || {};
        state.meta = metaRes || {};
        state.chartScale = {};
        setStatus('Data is not available yet. Trigger the "Fetch DOAJ journals (hourly)" GitHub Action, then refresh this page.');
        renderAll();
        return;
      }

      state.records = journalsRes;
      state.filtered = journalsRes;
      state.aggregates = aggRes || {};
      state.meta = metaRes || {};
      state.sjr = await loadSjrDataset();
      state.overlap = computeOverlap(state.records, state.sjr);
      state.overlapStats = computeOverlapStats(state.overlap);
      state.chartScale = computeChartScales(state.records);
      state.tablePage = 1;
      buildSearchTerms(state.records);
      setStatus('');
      populateFilters();
      renderAll();
    }

    function parseFxPayload(payload) {
      if (!payload || typeof payload !== 'object') return null;
      const base = String(payload.base || payload.base_code || '').trim().toUpperCase();
      const rates = payload.rates;
      if (base !== 'EUR' || !rates || typeof rates !== 'object') return null;

      const normalizedRates = { EUR: 1 };
      for (const [key, rawValue] of Object.entries(rates)) {
        const code = normalizeCurrencyCode(key);
        const rate = Number(rawValue);
        if (!code || !Number.isFinite(rate) || rate <= 0) continue;
        normalizedRates[code] = rate;
      }

      if (Object.keys(normalizedRates).length < 2) return null;
      const fxDate = payload.date || payload.time_last_update_utc || null;
      return { rates: normalizedRates, fxDate };
    }

    async function loadFxRates() {
      state.fxRates = null;
      state.fxDate = null;
      state.fxSource = null;

      for (const endpoint of FX_ENDPOINTS) {
        try {
          const res = await fetch(endpoint, { cache: 'no-store' });
          if (!res.ok) continue;
          const payload = await res.json();
          const parsed = parseFxPayload(payload);
          if (!parsed) continue;
          state.fxRates = parsed.rates;
          state.fxDate = parsed.fxDate;
          state.fxSource = endpoint;
          return true;
        } catch (_err) {
          // Try next endpoint.
        }
      }
      return false;
    }

    function renderFxSourceNote() {
      const el = document.getElementById('fx-source-note');
      if (!el) return;

      const defaultHtml = 'Exchange-rate sources: <a href="https://www.frankfurter.app/" target="_blank" rel="noopener noreferrer">Frankfurter API</a> (primary), <a href="https://open.er-api.com/" target="_blank" rel="noopener noreferrer">open.er-api.com</a> (fallback)';
      if (!state.fxSource) {
        el.innerHTML = `<div>${defaultHtml}</div>`;
        return;
      }

      let activeName = state.fxSource;
      let activeUrl = state.fxSource;
      if (state.fxSource.includes('frankfurter.app')) {
        activeName = 'Frankfurter API';
        activeUrl = 'https://www.frankfurter.app/';
      } else if (state.fxSource.includes('open.er-api.com')) {
        activeName = 'open.er-api.com';
        activeUrl = 'https://open.er-api.com/';
      }

      el.innerHTML = `<div>Exchange-rate source (active): <a href="${activeUrl}" target="_blank" rel="noopener noreferrer">${activeName}</a></div>`;
    }

    function populateFilters() {
      const countries = Array.from(new Set(state.records.map(r => r.country).filter(Boolean)))
        .sort((a, b) => formatCountry(a).localeCompare(formatCountry(b)));
      const subjects = Array.from(new Set(state.records.flatMap(r => toValueList(r.subject_terms))))
        .sort((a, b) => String(a).localeCompare(String(b)));
      const licenses = Array.from(new Set(state.records.flatMap(r => toValueList(r.license_type))))
        .sort((a, b) => String(a).localeCompare(String(b)));
      const peerReviews = Array.from(new Set(state.records.flatMap(r => getPeerReviewTerms(r.peer_review_type))))
        .sort((a, b) => String(a).localeCompare(String(b)));
      const languages = Array.from(new Set(state.records.flatMap(r => getSimpleTerms(r.language))))
        .sort((a, b) => String(a).localeCompare(String(b)));

      const countrySelect = document.getElementById('country');
      countrySelect.length = 1;
      countries.forEach(country => {
        const opt = document.createElement('option');
        opt.value = country;
        opt.textContent = formatCountry(country);
        countrySelect.appendChild(opt);
      });

      const subjectSelect = document.getElementById('subject-filter');
      subjectSelect.length = 1;
      subjects.forEach(subject => {
        const opt = document.createElement('option');
        opt.value = subject;
        opt.textContent = subject;
        subjectSelect.appendChild(opt);
      });

      const licenseSelect = document.getElementById('license');
      licenseSelect.length = 1;
      licenses.forEach(license => {
        const opt = document.createElement('option');
        opt.value = license;
        opt.textContent = license;
        licenseSelect.appendChild(opt);
      });

      const peerReviewSelect = document.getElementById('peer-review');
      peerReviewSelect.length = 1;
      peerReviews.forEach(review => {
        const opt = document.createElement('option');
        opt.value = review;
        opt.textContent = review;
        peerReviewSelect.appendChild(opt);
      });

      const languageSelect = document.getElementById('language');
      languageSelect.length = 1;
      languages.forEach(language => {
        const opt = document.createElement('option');
        opt.value = language;
        opt.textContent = language;
        languageSelect.appendChild(opt);
      });

      setupYearRange();
    }

    function applyFilters() {
      const country = document.getElementById('country').value;
      const subjectFilter = document.getElementById('subject-filter').value;
      const searchQuery = document.getElementById('search-query').value.trim().toLowerCase();
      const license = document.getElementById('license').value;
      const apc = document.getElementById('apc').value;
      const author = document.getElementById('author-retains').value;
      const tableApc = document.getElementById('table-apc').value;
      const tableAuthor = document.getElementById('table-author-retains').value;
      const peerReview = document.getElementById('peer-review').value;
      const language = document.getElementById('language').value;
      const publisher = document.getElementById('publisher').value.trim().toLowerCase();
      const yearFrom = parseInt(document.getElementById('year-from').value, 10);
      const yearTo = parseInt(document.getElementById('year-to').value, 10);

      state.filtered = state.records.filter(r => {
        if (country && r.country !== country) return false;
        if (subjectFilter && !toValueList(r.subject_terms).includes(subjectFilter)) return false;
        if (license && !toValueList(r.license_type).includes(license)) return false;
        if (apc === 'yes' && r.apc_has !== true) return false;
        if (apc === 'no' && r.apc_has !== false) return false;
        if (author === 'yes' && r.author_retains !== true) return false;
        if (author === 'no' && r.author_retains !== false) return false;
        if (tableApc === 'yes' && r.apc_has !== true) return false;
        if (tableApc === 'no' && r.apc_has !== false) return false;
        if (tableAuthor === 'yes' && r.author_retains !== true) return false;
        if (tableAuthor === 'no' && r.author_retains !== false) return false;
        if (peerReview && !getPeerReviewTerms(r.peer_review_type).includes(peerReview)) return false;
        if (language && !getSimpleTerms(r.language).includes(language)) return false;
        if (publisher && !(r.publisher || '').toLowerCase().includes(publisher)) return false;
        if (searchQuery) {
          const titleHit = (r.title || '').toLowerCase().includes(searchQuery);
          const countryHit = (formatCountry(r.country) || '').toLowerCase().includes(searchQuery);
          const subjectHit = toValueList(r.subject_terms).some(term => String(term).toLowerCase().includes(searchQuery));
          if (!titleHit && !countryHit && !subjectHit) return false;
        }
        if (state.yearBounds && !Number.isNaN(yearFrom) && !Number.isNaN(yearTo)) {
          const usesYearNarrowing = yearFrom > state.yearBounds.min || yearTo < state.yearBounds.max;
          if (usesYearNarrowing) {
            const y = getCreatedYear(r);
            if (y === null) return false;
            if (y < yearFrom || y > yearTo) return false;
          }
        }
        return true;
      });
      state.tablePage = 1;
      renderAll();
    }

    function resetFilters() {
      document.querySelectorAll('.filters select').forEach(el => { el.value = ''; });
      document.querySelectorAll('.filters input[type="text"]').forEach(el => { el.value = ''; });
      document.querySelectorAll('.table-inline-filters select').forEach(el => { el.value = ''; });
      const apcCountryContinentEl = document.getElementById('apc-country-continent');
      if (apcCountryContinentEl) apcCountryContinentEl.value = '';
      const searchEl = document.getElementById('search-query');
      if (searchEl) searchEl.value = '';
      resetYearRange();
      state.filtered = state.records;
      state.tablePage = 1;
      renderAll();
    }

    function renderKPIs() {
      const countries = new Set(state.filtered.map(r => r.country).filter(Boolean));
      const languages = new Set(state.filtered.flatMap(r => getSimpleTerms(r.language)));
      const noApc = state.filtered.filter(r => r.apc_has === false).length;

      document.getElementById('kpi-journals').textContent = formatNumber(state.filtered.length);
      document.getElementById('kpi-countries').textContent = formatNumber(countries.size);
      document.getElementById('kpi-articles').textContent = formatNumber(sumArticleRecords(state.filtered));
      document.getElementById('kpi-languages').textContent = formatNumber(languages.size);
      document.getElementById('kpi-no-apc').textContent = formatNumber(noApc);

      const metaText = `Source last updated: ${formatDate(state.meta.source_last_updated_max)}`;
      document.getElementById('meta-info').textContent = metaText;
      renderFxSourceNote();
      renderCountryTopSubjects();
    }

    function renderCountryTopSubjects() {
      const host = document.getElementById('country-subject-list');
      if (!host) return;
      host.innerHTML = '';

      // Build counts per country -> subject -> count
      const counts = new Map();
      for (const record of state.records) {
        if (!record.country) continue;
        const country = formatCountry(record.country);
        const subjects = toValueList(record.subject_terms);
        for (const subject of subjects) {
          if (!subject) continue;
          if (!counts.has(country)) counts.set(country, new Map());
          const cMap = counts.get(country);
          cMap.set(subject, (cMap.get(subject) || 0) + 1);
        }
      }

      const topPerCountry = [];
      for (const [country, subjMap] of counts.entries()) {
        if (!subjMap.size) continue;
        const entries = Array.from(subjMap.entries()).sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]));
        const [subject, count] = entries[0];
        topPerCountry.push({ country, subject, count });
      }

      topPerCountry.sort((a, b) => b.count - a.count || a.country.localeCompare(b.country));
      const top20 = topPerCountry.slice(0, 20);

      if (!top20.length) {
        host.innerHTML = '<div class=\"subject-empty\">No country/subject data</div>';
        return;
      }

      const palette = ['#982E0A', '#FD5A3B', '#47A178', '#3A5959', '#A3C386', '#F9D950', '#5C5956'];
      top20.forEach((item, idx) => {
        const row = document.createElement('div');
        row.className = 'country-subject-item';
        const nameEl = document.createElement('span');
        nameEl.className = 'country-subject-name';
        nameEl.textContent = item.country;

        const pill = document.createElement('span');
        pill.className = 'country-subject-pill';
        pill.style.backgroundColor = palette[idx % palette.length] + '26';
        pill.style.color = palette[idx % palette.length];
        pill.textContent = `${item.subject} (${formatNumber(item.count)})`;

        row.appendChild(nameEl);
        row.appendChild(pill);
        host.appendChild(row);
      });
    }

    function getMapPlotConfig() {
      return {
        displayModeBar: false,
        scrollZoom: false,
        doubleClick: false,
        responsive: true
      };
    }

    function renderMapContinentLegend(continentCounts) {
      const legendEl = document.getElementById('map-continent-legend');
      if (!legendEl) return;

      const preferredOrder = ['Africa', 'Asia', 'Europe', 'North America', 'South America', 'Oceania'];
      const items = [];

      for (const name of preferredOrder) {
        if (!continentCounts || !continentCounts[name]) continue;
        items.push({ name, color: CONTINENT_COLORS[name] || CONTINENT_COLORS.Other });
      }
      if (continentCounts && continentCounts.Other) {
        items.push({ name: 'Other', color: CONTINENT_COLORS.Other });
      }
      if (!items.length) {
        for (const name of preferredOrder) {
          items.push({ name, color: CONTINENT_COLORS[name] || CONTINENT_COLORS.Other });
        }
      }

      legendEl.innerHTML = `<div class="legend-title">Continents</div>${items.map(item => (
        `<div class="legend-item"><span class="legend-dot" style="background:${item.color}"></span><span>${item.name}</span></div>`
      )).join('')}`;
    }

    function resizeMapPlot() {
      const mapEl = document.getElementById('chart-country-map');
      if (!mapEl || typeof Plotly === 'undefined' || !Plotly.Plots || !Plotly.Plots.resize) return;
      Plotly.Plots.resize(mapEl);
    }

    function updateMapFullscreenButtonLabel() {
      const mapShell = document.getElementById('chart-country-map-shell');
      const button = document.getElementById('map-fullscreen-btn');
      if (!mapShell || !button) return;
      const isFullscreen = document.fullscreenElement === mapShell || document.webkitFullscreenElement === mapShell;
      button.textContent = isFullscreen ? 'Back to the main page' : 'Full page map';
    }

    function openMapFullscreen() {
      const mapEl = document.getElementById('chart-country-map');
      const mapShell = document.getElementById('chart-country-map-shell');
      if (!mapEl || !mapShell) return;

      const isFullscreen = document.fullscreenElement === mapShell || document.webkitFullscreenElement === mapShell;
      if (isFullscreen) {
        const exit = document.exitFullscreen || document.webkitExitFullscreen;
        if (exit) exit.call(document);
        setTimeout(updateMapFullscreenButtonLabel, 60);
        return;
      }

      const request =
        mapShell.requestFullscreen ||
        mapShell.webkitRequestFullscreen ||
        mapShell.mozRequestFullScreen ||
        mapShell.msRequestFullscreen;
      if (request) request.call(mapShell);
      setTimeout(updateMapFullscreenButtonLabel, 60);
      setTimeout(resizeMapPlot, 220);
    }

    function renderCharts() {
      if (!state.filtered.length) {
        renderEmptyCharts();
        return;
      }

      const apcYes = state.filtered.filter(record => record.apc_has === true).length;
      const apcNo = state.filtered.filter(record => record.apc_has === false).length;
      renderYesNoShareChart('chart-apc-overview', 'Article Processing Charges', apcYes, apcNo, {
        yesColor: '#47A178',
        noColor: '#FD5A3B'
      });

      const authorRetainsYes = state.filtered.filter(record => record.author_retains === true).length;
      const authorRetainsNo = state.filtered.filter(record => record.author_retains === false).length;
      renderYesNoShareChart('chart-author-retains', 'Authors retain copyright', authorRetainsYes, authorRetainsNo, {
        yesColor: '#3A5959',
        noColor: '#FA9A87'
      });

      const countryCounts = {};
      for (const record of state.filtered) {
        if (record.country) countryCounts[record.country] = (countryCounts[record.country] || 0) + 1;
      }
      const topCountries = sortedEntries(countryCounts, 10).map(([country, count]) => [formatCountry(country), count]);
      renderHorizontalBarChart('chart-country', 'Top 10 countries', topCountries, {
        leftMargin: 260,
        color: '#3A5959',
        fixedMax: state.chartScale.countryMax
      });

      const mapEntries = sortedEntries(countryCounts);
      const maxCountryCount = Math.max(Number(state.chartScale.mapCountryMax) || 0, ...mapEntries.map(([, count]) => count), 1);
      const continentCounts = {};
      const continentBuckets = {};
      for (const [country, count] of mapEntries) {
        const continent = getContinent(country);
        continentCounts[continent] = (continentCounts[continent] || 0) + count;
        if (!continentBuckets[continent]) continentBuckets[continent] = [];
        continentBuckets[continent].push([country, count]);
      }
      const continentEntries = sortedEntries(continentCounts).map(([continent, count]) => [continent, count]);
      const continentColors = continentEntries.map(([continent]) => CONTINENT_COLORS[continent] || CONTINENT_COLORS.Other);
      renderHorizontalBarChart('chart-continent', 'Journals in each continent', continentEntries, {
        leftMargin: 210,
        colors: continentColors,
        fixedMax: state.chartScale.continentMax
      });

      const languageCounts = countTermFrequency(state.filtered, r => getSimpleTerms(r.language));
      const topLanguages = sortedEntries(languageCounts, 10).map(([term, count]) => [shortLabel(term, 56), count]);
      renderHorizontalBarChart('chart-languages', 'Top 10 languages', topLanguages, {
        leftMargin: 280,
        color: '#A3C386',
        fixedMax: state.chartScale.languageMax
      });

      const subjectCounts = countTermFrequency(state.filtered, r => toValueList(r.subject_terms));
      const topSubjects = sortedEntries(subjectCounts, 10).map(([term, count]) => [shortLabel(term, 60), count]);
      renderHorizontalBarChart('chart-subjects', 'Top 10 subjects', topSubjects, {
        leftMargin: 320,
        color: '#FA9A87',
        fixedMax: state.chartScale.subjectMax
      });

      const licenseCounts = countTermFrequency(state.filtered, r => toValueList(r.license_type));
      const topLicenses = sortedEntries(licenseCounts, 12).map(([term, count]) => [shortLabel(term, 56), count]);
      renderHorizontalBarChart('chart-license', 'License usage', topLicenses, {
        leftMargin: 300,
        color: '#FD5A3B',
        fixedMax: state.chartScale.licenseMax
      });

      const peerCounts = countTermFrequency(state.filtered, r => getPeerReviewTerms(r.peer_review_type), true);
      const topPeer = sortedEntries(peerCounts, 5);
      const peerColors = topPeer.map(([label]) => (label === NOT_AVAILABLE ? '#982E0A' : '#47A178'));
      renderHorizontalBarChart(
        'chart-peer-review',
        'Top 5 peer-review type',
        topPeer.map(([label, count]) => [shortLabel(label, 56), count]),
        { leftMargin: 300, colors: peerColors, fixedMax: state.chartScale.peerMax }
      );

      const pidCounts = countTermFrequency(state.filtered, r => getPidSchemes(r.pid_scheme), true);
      const topPid = sortedEntries(pidCounts, 5);
      const pidColors = topPid.map(([label]) => (label === NOT_AVAILABLE ? '#982E0A' : '#3A5959'));
      renderHorizontalBarChart(
        'chart-pid',
        'Top 5 Persistent Identifiers',
        topPid.map(([label, count]) => [shortLabel(formatPidScheme(label), 56), count]),
        { leftMargin: 300, colors: pidColors, fixedMax: state.chartScale.pidMax }
      );

      const preservationCounts = countTermFrequency(state.filtered, r => getPreservationTerms(r.preservation_service), true);
      const topPreservation = sortedEntries(preservationCounts, 5);
      const preservationPalette = ['#3A5959', '#47A178', '#A3C386', '#FD5A3B', '#FA9A87'];
      const preservationColors = topPreservation.map(([label], idx) => (label === NOT_AVAILABLE ? '#982E0A' : preservationPalette[idx % preservationPalette.length]));
      renderHorizontalBarChart(
        'chart-preservation',
        'Top 5 Preservation Services',
        topPreservation.map(([label, count]) => [shortLabel(label, 58), count]),
        { leftMargin: 320, colors: preservationColors, fixedMax: state.chartScale.preservationMax }
      );

      const publisherCounts = {};
      for (const record of state.filtered) {
        const publisher = (record.publisher || '').trim();
        if (!publisher) continue;
        publisherCounts[publisher] = (publisherCounts[publisher] || 0) + 1;
      }
      const topPublishers = sortedEntries(publisherCounts, 10).map(([name, count]) => [shortLabel(name, 60), count]);
      renderHorizontalBarChart('chart-publishers', 'Top 10 publishers', topPublishers, {
        leftMargin: 300,
        color: '#3A5959',
        fixedMax: state.chartScale.publisherMax
      });

      const timelineSeries = buildMonthlyTimeline(state.filtered);
      if (!timelineSeries.dates.length) {
        renderNoDataChart('chart-timeline', 'Timeline of journals added to DOAJ (monthly)');
      } else {
        const timelineYMax = Math.max(
          Number(state.chartScale.timelineMax) || 0,
          ...timelineSeries.counts,
          ...timelineSeries.movingAvg,
          1
        );
        Plotly.newPlot(
          'chart-timeline',
          [{
            type: 'bar',
            name: 'Monthly additions',
            x: timelineSeries.dates,
            y: timelineSeries.counts,
            marker: { color: '#A3C386' },
            hovertemplate: '%{x|%b %Y}: %{y:,d} journals<extra></extra>'
          }, {
            type: 'scatter',
            mode: 'lines',
            name: '3-month moving average',
            x: timelineSeries.dates,
            y: timelineSeries.movingAvg,
            line: { color: '#3A5959', width: 3 },
            hovertemplate: '%{x|%b %Y}: %{y:.1f} journals<extra></extra>'
          }],
          {
            title: 'Timeline of journals added to DOAJ (monthly)',
            margin: { l: 52, r: 44, t: 46, b: 58 },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: '#282624' },
            legend: { orientation: 'h', x: 0, y: -0.22 },
            xaxis: { type: 'date', tickformat: '%b %Y' },
            yaxis: {
              tickformat: ',d',
              separatethousands: true,
              range: [0, timelineYMax * 1.08]
            }
          },
          { displayModeBar: false }
        );
      }

      const apcContinent = (document.getElementById('apc-country-continent') || {}).value || '';
      const apcCurrency = getSelectedApcCurrency();
      const apcCountryScaleStats = getApcCountryStats(state.records, apcCurrency);
      const apcCountryFixedMax = apcCountryScaleStats.length
        ? Math.max(...apcCountryScaleStats.map(entry => entry.median))
        : 0;

      let apcCountryStats = getApcCountryStats(state.filtered, apcCurrency);
      if (apcContinent) {
        apcCountryStats = apcCountryStats.filter(entry => entry.continent === apcContinent);
      }
      const apcColumns = window.innerWidth <= 700 ? 1 : 2;
      const apcTitle = apcContinent
        ? `Top 20 countries by APC amount (median ${apcCurrency}) - ${apcContinent}`
        : `Top 20 countries by APC amount (median ${apcCurrency})`;
      renderApcCountryChart(
        'chart-apc-distribution',
        apcTitle,
        apcCountryStats,
        {
          fixedMax: apcCountryFixedMax,
          limit: 20,
          columns: apcColumns,
          currency: apcCurrency
        }
      );

      const continentOrder = Object.entries(continentCounts).sort((a, b) => b[1] - a[1]).map(([name]) => name);
      const mapTraces = continentOrder.map(continent => {
        const entries = continentBuckets[continent] || [];
        return {
          type: 'scattergeo',
          mode: 'markers',
          locationmode: 'country names',
          name: continent,
          locations: entries.map(([country]) => formatCountry(country)),
          text: entries.map(([country, count]) => `${formatCountry(country)}: ${formatNumber(count)} journals`),
          hovertemplate: '%{text}<extra></extra>',
          marker: {
            color: CONTINENT_COLORS[continent] || CONTINENT_COLORS.Other,
            opacity: 0.78,
            line: { color: '#282624', width: 0.5 },
            size: entries.map(([, count]) => 8 + Math.sqrt(count / maxCountryCount) * 34)
          }
        };
      });

      Plotly.newPlot(
        'chart-country-map',
        mapTraces,
        {
          title: 'Country of Publishers',
          margin: { l: 10, r: 44, t: 46, b: 10 },
          paper_bgcolor: 'rgba(0,0,0,0)',
          showlegend: false,
          geo: {
            showframe: false,
            showcoastlines: true,
            coastlinecolor: '#D7D2CE',
            showcountries: true,
            countrycolor: '#D7D2CE',
            showland: true,
            landcolor: '#FFFFFF',
            bgcolor: 'rgba(0,0,0,0)',
            projection: { type: 'natural earth' }
          }
        },
        getMapPlotConfig()
      );
      renderMapContinentLegend(continentCounts);
      setTimeout(resizeMapPlot, 50);
    }

    function renderEmptyCharts() {
      renderYesNoShareChart('chart-apc-overview', 'Article Processing Charges', 0, 0);
      renderYesNoShareChart('chart-author-retains', 'Authors retain copyright', 0, 0);

      const emptyCharts = [
        ['chart-country', 'Top 10 countries'],
        ['chart-continent', 'Journals in each continent'],
        ['chart-languages', 'Top 10 languages'],
        ['chart-subjects', 'Top 10 subjects'],
        ['chart-license', 'License usage'],
        ['chart-peer-review', 'Top 5 peer-review type'],
        ['chart-pid', 'Top 5 Persistent Identifiers'],
        ['chart-preservation', 'Top 5 Preservation Services'],
        ['chart-publishers', 'Top 10 publishers'],
        ['chart-timeline', 'Timeline of journals added to DOAJ (monthly)']
      ];
      emptyCharts.forEach(([id, title]) => renderHorizontalBarChart(id, title, []));
      const apcCurrency = getSelectedApcCurrency();
      renderApcCountryChart(
        'chart-apc-distribution',
        `Top 20 countries by APC amount (median ${apcCurrency})`,
        [],
        { limit: 20, columns: 2, currency: apcCurrency }
      );

      Plotly.newPlot(
        'chart-country-map',
        [],
        {
          title: 'Country of Publishers',
          margin: { l: 10, r: 44, t: 46, b: 10 },
          paper_bgcolor: 'rgba(0,0,0,0)',
          showlegend: false,
          geo: { showframe: false, showcoastlines: true, showcountries: true, showland: true },
          annotations: [{ text: 'No data yet', showarrow: false, x: 0.5, y: 0.5, xref: 'paper', yref: 'paper' }]
        },
        getMapPlotConfig()
      );
      renderMapContinentLegend({});
      setTimeout(resizeMapPlot, 50);
    }

    function renderTable() {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';
      const apcCurrency = getSelectedApcCurrency();
      const apcHeaderEl = document.getElementById('th-apc-max');
      if (apcHeaderEl) {
        apcHeaderEl.textContent = `APC (max ${apcCurrency})`;
      }

      const sortDirection = document.getElementById('country-sort').value;
      const sorted = [...state.filtered];
      if (sortDirection === 'asc' || sortDirection === 'desc') {
        const dir = sortDirection === 'asc' ? 1 : -1;
        sorted.sort((a, b) => {
          const countryCompare = formatCountry(a.country).localeCompare(formatCountry(b.country));
          if (countryCompare !== 0) return countryCompare * dir;
          return String(a.title || '').localeCompare(String(b.title || ''));
        });
      }

      const total = sorted.length;
      const pageSize = state.tablePageSize;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (state.tablePage > totalPages) state.tablePage = totalPages;
      if (state.tablePage < 1) state.tablePage = 1;

      const startIndex = (state.tablePage - 1) * pageSize;
      const rows = sorted.slice(startIndex, startIndex + pageSize);
      const shownFrom = total ? startIndex + 1 : 0;
      const shownTo = total ? startIndex + rows.length : 0;

      document.getElementById('table-count').textContent = `${shownFrom}-${shownTo} of ${total} filtered`;
      document.getElementById('table-page').textContent = `Page ${state.tablePage} of ${totalPages}`;
      document.getElementById('table-prev').disabled = state.tablePage <= 1;
      document.getElementById('table-next').disabled = state.tablePage >= totalPages;

      if (!rows.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 8;
        td.className = 'muted';
        td.textContent = 'No journal data available yet.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      for (const record of rows) {
        const tr = document.createElement('tr');

        const titleCell = document.createElement('td');
        const titleText = record.title || NOT_AVAILABLE;
        const linkUrl = (record.doaj_url || '').trim();
        if (linkUrl && /^https?:\/\//i.test(linkUrl) && record.title) {
          const link = document.createElement('a');
          link.className = 'table-link';
          link.href = linkUrl;
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.textContent = titleText;
          titleCell.appendChild(link);
        } else {
          titleCell.textContent = titleText;
        }
        tr.appendChild(titleCell);

        const countryCell = document.createElement('td');
        const countryName = formatCountry(record.country);
        countryCell.textContent = countryName;
        countryCell.className = 'country-text';
        const countryContinent = getCountryContinent(record.country);
        countryCell.style.color = CONTINENT_COLORS[countryContinent] || CONTINENT_COLORS.Other;
        tr.appendChild(countryCell);

        const subjectCell = document.createElement('td');
        const subjectTerms = toValueList(record.subject_terms);
        subjectCell.textContent = subjectTerms.length ? shortLabel(subjectTerms[0], 72) : NOT_AVAILABLE;
        tr.appendChild(subjectCell);

        const apcCell = document.createElement('td');
        if (record.apc_has === true || record.apc_has === false) {
          const badge = document.createElement('span');
          badge.className = `pill${record.apc_has ? '' : ' negative'}`;
          badge.textContent = record.apc_has ? 'Yes' : 'No';
          apcCell.appendChild(badge);
        } else {
          apcCell.textContent = NOT_AVAILABLE;
        }
        tr.appendChild(apcCell);

        const apcMaxCell = document.createElement('td');
        const maxApcValue = getMaxApcInCurrency(record, apcCurrency);
        apcMaxCell.textContent = maxApcValue === null ? '0' : formatCurrencyWhole(maxApcValue, apcCurrency);
        tr.appendChild(apcMaxCell);

        const articleCell = document.createElement('td');
        const articleValue = getArticleRecords(record);
        articleCell.textContent = articleValue === null ? NOT_AVAILABLE : formatNumber(articleValue);
        if (articleValue === 0 && isOverOneMonth(record)) {
          const overTag = document.createElement('span');
          overTag.className = 'pill warn';
          overTag.textContent = 'Over 1 month';
          articleCell.appendChild(overTag);
        }
        tr.appendChild(articleCell);

        const includedCell = document.createElement('td');
        includedCell.textContent = record.created_date ? formatDate(record.created_date) : NOT_AVAILABLE;
        tr.appendChild(includedCell);

        const updatedCell = document.createElement('td');
        updatedCell.textContent = record.last_updated ? formatDate(record.last_updated) : NOT_AVAILABLE;
        tr.appendChild(updatedCell);

        tbody.appendChild(tr);
      }
    }

    function renderOverlapSummary() {
      const box = document.getElementById('overlap-box');
      const statusEl = document.getElementById('overlap-status');
      if (!box || !statusEl) return;
      const stats = state.overlapStats;
      if (!stats) {
        statusEl.textContent = 'No SJR overlap data available.';
        ['ov-count','ov-quartiles','ov-cites','ov-hindex','ov-sjr','ov-countries','ov-areas'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.textContent = '–';
        });
        return;
      }
      statusEl.textContent = '';
      const countEl = document.getElementById('ov-count');
      if (countEl) countEl.textContent = formatNumber(stats.count);

      const qEl = document.getElementById('ov-quartiles');
      if (qEl) {
        qEl.innerHTML = '';
        const ordered = ['Q1','Q2','Q3','Q4',NOT_AVAILABLE];
        ordered.forEach(q => {
          if (stats.quartiles[q]) {
            const li = document.createElement('li');
            li.textContent = `${q}: ${formatNumber(stats.quartiles[q])}`;
            qEl.appendChild(li);
          }
        });
      }

      const cEl = document.getElementById('ov-cites');
      if (cEl) {
        cEl.innerHTML = '';
        const entries = Object.entries(stats.avgCitesByQuartile).sort((a,b)=>a[0].localeCompare(b[0]));
        entries.forEach(([q, avg]) => {
          const li = document.createElement('li');
          li.textContent = `${q}: ${avg ? avg.toFixed(2) : '0'}`;
          cEl.appendChild(li);
        });
      }

      const hEl = document.getElementById('ov-hindex');
      if (hEl) hEl.textContent = `${formatNumber(Math.round(stats.hIndex.p10))} / ${formatNumber(Math.round(stats.hIndex.median))} / ${formatNumber(Math.round(stats.hIndex.p90))}`;

      const sjrEl = document.getElementById('ov-sjr');
      if (sjrEl) sjrEl.textContent = `${stats.sjr.min.toFixed(2)} / ${stats.sjr.median.toFixed(2)} / ${stats.sjr.p90.toFixed(2)}`;

      const countriesEl = document.getElementById('ov-countries');
      if (countriesEl) {
        countriesEl.innerHTML = '';
        stats.topCountries.forEach(([name, count]) => {
          const li = document.createElement('li');
          li.textContent = `${name}: ${formatNumber(count)}`;
          countriesEl.appendChild(li);
        });
      }

      const areasEl = document.getElementById('ov-areas');
      if (areasEl) {
        areasEl.innerHTML = '';
        stats.topAreas.forEach(([name, count]) => {
          const li = document.createElement('li');
          li.textContent = `${name}: ${formatNumber(count)}`;
          areasEl.appendChild(li);
        });
      }
    }

    function renderAll() {
      renderKPIs();
      renderCharts();
      renderTable();
      renderOverlapSummary();
    }

    function wireEvents() {
      document.querySelectorAll('.filters select, .filters input[type="text"]').forEach(el => {
        el.addEventListener('change', applyFilters);
        el.addEventListener('keyup', ev => { if (ev.key === 'Enter') applyFilters(); });
      });
      document.querySelectorAll('.table-inline-filters select').forEach(el => {
        el.addEventListener('change', applyFilters);
      });
      const apcCountryContinentEl = document.getElementById('apc-country-continent');
      if (apcCountryContinentEl) {
        apcCountryContinentEl.addEventListener('change', () => renderCharts());
      }
      const apcCurrencyEl = document.getElementById('apc-currency');
      if (apcCurrencyEl) {
        apcCurrencyEl.addEventListener('change', () => {
          renderCharts();
          renderTable();
        });
      }
      const searchEl = document.getElementById('search-query');
      let searchDebounceTimer = null;
      searchEl.addEventListener('input', () => {
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => applyFilters(), 180);
      });

      const mapFullscreenBtn = document.getElementById('map-fullscreen-btn');
      if (mapFullscreenBtn) {
        mapFullscreenBtn.addEventListener('click', openMapFullscreen);
      }
      document.addEventListener('fullscreenchange', () => {
        setTimeout(resizeMapPlot, 60);
        setTimeout(updateMapFullscreenButtonLabel, 60);
      });
      document.addEventListener('webkitfullscreenchange', () => {
        setTimeout(resizeMapPlot, 60);
        setTimeout(updateMapFullscreenButtonLabel, 60);
      });
      window.addEventListener('resize', () => setTimeout(resizeMapPlot, 60));
      updateMapFullscreenButtonLabel();

      document.getElementById('table-prev').addEventListener('click', () => {
        if (state.tablePage <= 1) return;
        state.tablePage -= 1;
        renderTable();
      });
      document.getElementById('table-next').addEventListener('click', () => {
        state.tablePage += 1;
        renderTable();
      });

      const fromEl = document.getElementById('year-from');
      const toEl = document.getElementById('year-to');
      fromEl.addEventListener('input', () => {
        if (parseInt(fromEl.value, 10) > parseInt(toEl.value, 10)) {
          toEl.value = fromEl.value;
        }
        syncYearLabels();
        applyFilters();
      });
      toEl.addEventListener('input', () => {
        if (parseInt(toEl.value, 10) < parseInt(fromEl.value, 10)) {
          fromEl.value = toEl.value;
        }
        syncYearLabels();
        applyFilters();
      });
      document.getElementById('reset').addEventListener('click', resetFilters);
    }

    async function init() {
      try {
        wireEvents();
        await loadData();
        if (state.records.length) {
          await loadFxRates();
          state.chartScale = computeChartScales(state.records);
          renderAll();
        }
      } catch (err) {
        console.error(err);
        state.records = [];
        state.filtered = [];
        state.meta = {};
        state.chartScale = {};
        setStatus('Unable to load dashboard data. Check GitHub Actions logs and refresh.');
        renderAll();
      }
    }

    init();
  </script>
</body>
</html>
